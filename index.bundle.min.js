var t="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{},e=e||{};e.Geometry=function(){},e.Geometry.intersectLineLine=function(t,e){var n=(t.intercept-e.intercept)/(e.slope-t.slope);return{x:n,y:t.slope*n+t.intercept}},e.Geometry.distanceFromOrigin=function(t){return Math.sqrt(Math.pow(t.x,2)+Math.pow(t.y,2))},e.Geometry.distanceLineFromOrigin=function(t){return Math.abs(t.intercept)/Math.sqrt(Math.pow(t.slope,2)+1)},e.Geometry.perpendicularThroughPoint=function(t,e){var n=-1/t.slope;return{slope:n,intercept:e.y-n*e.x}},e.Geometry.angleFromOrigin=function(t){return Math.atan2(t.y,t.x)},e.Geometry.normalizeAngle=function(t){var e=2*Math.PI;return(t%e+e)%e},e.Geometry.lengthOfRayUntilIntersect=function(t,e){return e.intercept/(Math.sin(t)-e.slope*Math.cos(t))},e.Hsluv=function(){},e.Hsluv.getBounds=function(t){for(var n=[],r=Math.pow(t+16,3)/1560896,s=r>e.Hsluv.epsilon?r:t/e.Hsluv.kappa,i=0;i<3;)for(var o=i++,l=e.Hsluv.m[o][0],a=e.Hsluv.m[o][1],u=e.Hsluv.m[o][2],c=0;c<2;){var h=c++,f=(284517*l-94839*u)*s,d=(838422*u+769860*a+731718*l)*t*s-769860*h*t,m=(632260*u-126452*a)*s+126452*h;n.push({slope:f/m,intercept:d/m})}return n},e.Hsluv.maxSafeChromaForL=function(t){for(var n=e.Hsluv.getBounds(t),r=1/0,s=0;s<n.length;){var i=n[s];++s;var o=e.Geometry.distanceLineFromOrigin(i);r=Math.min(r,o)}return r},e.Hsluv.maxChromaForLH=function(t,n){for(var r=n/360*Math.PI*2,s=e.Hsluv.getBounds(t),i=1/0,o=0;o<s.length;){var l=s[o];++o;var a=e.Geometry.lengthOfRayUntilIntersect(r,l);a>=0&&(i=Math.min(i,a))}return i},e.Hsluv.dotProduct=function(t,e){for(var n=0,r=0,s=t.length;r<s;){var i=r++;n+=t[i]*e[i]}return n},e.Hsluv.fromLinear=function(t){return t<=.0031308?12.92*t:1.055*Math.pow(t,.4166666666666667)-.055},e.Hsluv.toLinear=function(t){return t>.04045?Math.pow((t+.055)/1.055,2.4):t/12.92},e.Hsluv.xyzToRgb=function(t){return[e.Hsluv.fromLinear(e.Hsluv.dotProduct(e.Hsluv.m[0],t)),e.Hsluv.fromLinear(e.Hsluv.dotProduct(e.Hsluv.m[1],t)),e.Hsluv.fromLinear(e.Hsluv.dotProduct(e.Hsluv.m[2],t))]},e.Hsluv.rgbToXyz=function(t){var n=[e.Hsluv.toLinear(t[0]),e.Hsluv.toLinear(t[1]),e.Hsluv.toLinear(t[2])];return[e.Hsluv.dotProduct(e.Hsluv.minv[0],n),e.Hsluv.dotProduct(e.Hsluv.minv[1],n),e.Hsluv.dotProduct(e.Hsluv.minv[2],n)]},e.Hsluv.yToL=function(t){return t<=e.Hsluv.epsilon?t/e.Hsluv.refY*e.Hsluv.kappa:116*Math.pow(t/e.Hsluv.refY,.3333333333333333)-16},e.Hsluv.lToY=function(t){return t<=8?e.Hsluv.refY*t/e.Hsluv.kappa:e.Hsluv.refY*Math.pow((t+16)/116,3)},e.Hsluv.xyzToLuv=function(t){var n=t[0],r=t[1],s=n+15*r+3*t[2],i=4*n,o=9*r;0!=s?(i/=s,o/=s):(i=NaN,o=NaN);var l=e.Hsluv.yToL(r);return 0==l?[0,0,0]:[l,13*l*(i-e.Hsluv.refU),13*l*(o-e.Hsluv.refV)]},e.Hsluv.luvToXyz=function(t){var n=t[0],r=t[1],s=t[2];if(0==n)return[0,0,0];var i=r/(13*n)+e.Hsluv.refU,o=s/(13*n)+e.Hsluv.refV,l=e.Hsluv.lToY(n),a=0-9*l*i/((i-4)*o-i*o);return[a,l,(9*l-15*o*l-o*a)/(3*o)]},e.Hsluv.luvToLch=function(t){var e,n=t[0],r=t[1],s=t[2],i=Math.sqrt(r*r+s*s);i<1e-8?e=0:(e=180*Math.atan2(s,r)/Math.PI)<0&&(e=360+e);return[n,i,e]},e.Hsluv.lchToLuv=function(t){var e=t[0],n=t[1],r=t[2]/360*2*Math.PI;return[e,Math.cos(r)*n,Math.sin(r)*n]},e.Hsluv.hsluvToLch=function(t){var n=t[0],r=t[1],s=t[2];return s>99.9999999?[100,0,n]:s<1e-8?[0,0,n]:[s,e.Hsluv.maxChromaForLH(s,n)/100*r,n]},e.Hsluv.lchToHsluv=function(t){var n=t[0],r=t[1],s=t[2];return n>99.9999999?[s,0,100]:n<1e-8?[s,0,0]:[s,r/e.Hsluv.maxChromaForLH(n,s)*100,n]},e.Hsluv.hpluvToLch=function(t){var n=t[0],r=t[1],s=t[2];return s>99.9999999?[100,0,n]:s<1e-8?[0,0,n]:[s,e.Hsluv.maxSafeChromaForL(s)/100*r,n]},e.Hsluv.lchToHpluv=function(t){var n=t[0],r=t[1],s=t[2];return n>99.9999999?[s,0,100]:n<1e-8?[s,0,0]:[s,r/e.Hsluv.maxSafeChromaForL(n)*100,n]},e.Hsluv.rgbToHex=function(t){for(var n="#",r=0;r<3;){var s=t[r++],i=Math.round(255*s),o=i%16,l=(i-o)/16|0;n+=e.Hsluv.hexChars.charAt(l)+e.Hsluv.hexChars.charAt(o)}return n},e.Hsluv.hexToRgb=function(t){t=t.toLowerCase();for(var n=[],r=0;r<3;){var s=r++,i=16*e.Hsluv.hexChars.indexOf(t.charAt(2*s+1))+e.Hsluv.hexChars.indexOf(t.charAt(2*s+2));n.push(i/255)}return n},e.Hsluv.lchToRgb=function(t){return e.Hsluv.xyzToRgb(e.Hsluv.luvToXyz(e.Hsluv.lchToLuv(t)))},e.Hsluv.rgbToLch=function(t){return e.Hsluv.luvToLch(e.Hsluv.xyzToLuv(e.Hsluv.rgbToXyz(t)))},e.Hsluv.hsluvToRgb=function(t){return e.Hsluv.lchToRgb(e.Hsluv.hsluvToLch(t))},e.Hsluv.rgbToHsluv=function(t){return e.Hsluv.lchToHsluv(e.Hsluv.rgbToLch(t))},e.Hsluv.hpluvToRgb=function(t){return e.Hsluv.lchToRgb(e.Hsluv.hpluvToLch(t))},e.Hsluv.rgbToHpluv=function(t){return e.Hsluv.lchToHpluv(e.Hsluv.rgbToLch(t))},e.Hsluv.hsluvToHex=function(t){return e.Hsluv.rgbToHex(e.Hsluv.hsluvToRgb(t))},e.Hsluv.hpluvToHex=function(t){return e.Hsluv.rgbToHex(e.Hsluv.hpluvToRgb(t))},e.Hsluv.hexToHsluv=function(t){return e.Hsluv.rgbToHsluv(e.Hsluv.hexToRgb(t))},e.Hsluv.hexToHpluv=function(t){return e.Hsluv.rgbToHpluv(e.Hsluv.hexToRgb(t))},e.Hsluv.m=[[3.240969941904521,-1.537383177570093,-.498610760293],[-.96924363628087,1.87596750150772,.041555057407175],[.055630079696993,-.20397695888897,1.056971514242878]],e.Hsluv.minv=[[.41239079926595,.35758433938387,.18048078840183],[.21263900587151,.71516867876775,.072192315360733],[.019330818715591,.11919477979462,.95053215224966]],e.Hsluv.refY=1,e.Hsluv.refU=.19783000664283,e.Hsluv.refV=.46831999493879,e.Hsluv.kappa=903.2962962,e.Hsluv.epsilon=.0088564516,e.Hsluv.hexChars="0123456789abcdef";var n={hsluvToRgb:e.Hsluv.hsluvToRgb,rgbToHsluv:e.Hsluv.rgbToHsluv,hpluvToRgb:e.Hsluv.hpluvToRgb,rgbToHpluv:e.Hsluv.rgbToHpluv,hsluvToHex:e.Hsluv.hsluvToHex,hexToHsluv:e.Hsluv.hexToHsluv,hpluvToHex:e.Hsluv.hpluvToHex,hexToHpluv:e.Hsluv.hexToHpluv,lchToHpluv:e.Hsluv.lchToHpluv,hpluvToLch:e.Hsluv.hpluvToLch,lchToHsluv:e.Hsluv.lchToHsluv,hsluvToLch:e.Hsluv.hsluvToLch,lchToLuv:e.Hsluv.lchToLuv,luvToLch:e.Hsluv.luvToLch,xyzToLuv:e.Hsluv.xyzToLuv,luvToXyz:e.Hsluv.luvToXyz,xyzToRgb:e.Hsluv.xyzToRgb,rgbToXyz:e.Hsluv.rgbToXyz,lchToRgb:e.Hsluv.lchToRgb,rgbToLch:e.Hsluv.rgbToLch};function r({err:t,value:e}){if(t)throw t;return e}function s(t){return{value:t}}function i(t){return{err:t}}function o(t){try{return t()}catch(t){return i(t instanceof Error?t:new Error(`${t}`))}}function l(t,e){return t.err?t:e(t.value)}const a=new Map;function u(t){const e=/^(\w+)(?:\((.*)\))?$/.exec(t);if(!e)return i(new Error("invalid color spec"));const n=e[1]||"",r=a.get(n);if(!r){const t=Object.keys(a).sort().join(", ");return i(new Error(`no such color scheme ${JSON.stringify(n)}, valid choices: ${t}`))}const o=e[2]?e[2].split(/, */):[];return s(r(o[0]?parseInt(o[0],10):void 0,o[1]?parseInt(o[1],10):void 0))}function c(t,e,n){const r=t.querySelector(e);if(!r)throw new Error(`unable to find a ${e}`);if(!(r instanceof n))throw new Error(`invalid ${e} element, must be a ${n.name} instance`);return r}function h(t,e,n){const r=t.querySelector(e);if(!r)return null;if(!(r instanceof n))throw new Error(`invalid ${e} element, must be a ${n.name} instance`);return r}function f(t){const e=function(){let t=[];const e=new Map,n=new Map,r=new Map,s=new Map;function i(n){let s="",i=0;const o=t[i];let l=o&&r.get(o);if(l)s=o+l(n),i++;else{if(l=r.get(""),!l)throw new Error("no default keyEncoder available!");s=l(n)}for(;i<t.length;i++){const n=t[i],r=n&&e.get(n);if(!r)break;s=n+r(s)}return s}function o(t){const e=t;t:for(let e=100;e-- >0;){for(const[e,n]of s)if(t.startsWith(e))return n(t.slice(e.length));for(const[e,r]of n)if(t.startsWith(e)){t=r(t.slice(e.length));continue t}break}throw t===e?new Error(`unable to decode: ${JSON.stringify(t)}`):new Error(`unable to decode: ${JSON.stringify(t)}, original form: ${JSON.stringify(e)}`)}function l(t,{encode:i,decode:o,encodeKeys:l,decodeKeys:a}){i&&e.set(t,i),o&&n.set(t,o),l&&r.set(t,l),a&&s.set(t,a)}return{get defaultEncoding(){switch(t.length){case 0:return"";case 1:return t[0]||"";default:return t.join("")}},set defaultEncoding(n){const r=[];let s=n;t:for(;s.length;){for(const t of e.keys())if(s.startsWith(t)){r.push(t),s=s.slice(t.length);continue t}throw new Error(`invalid encoding ${JSON.stringify(s)} in ${JSON.stringify(n)}`)}t=r},addCodec:l,encode:i,decode:o}}();e.addCodec("",{encodeKeys(t){const e=[];for(const[n,r]of t){let t=encodeURIComponent(n);void 0!==r&&""!==r&&(t+="="+encodeURIComponent(r)),e.push(t)}return e.join("&")},*decodeKeys(t){for(const e of t.split("&")){let[t,n]=e.split("=");t=decodeURIComponent(t||""),n=decodeURIComponent(n||""),t&&(yield[t,n])}}}),e.addCodec("b64:",{encode:btoa,decode:atob});const n=new Map,i=new Map,o=new Map,l=new Map,a=new Map,u=new Map;let c="",h=!1;function f(r=t.location.hash){const s=function(t){let r=!1;const s=new Set,l=[];for(const[r,i]of e.decode(t.slice(1)))s.add(r),n.get(r)!==i&&(n.set(r,i),l.push({key:r,value:m(r)}));for(const[t,e]of o.entries())if(!s.has(t)&&(s.add(t),i.get(t)!==e)){if(void 0===e)i.delete(t),n.delete(t);else{i.set(t,e);const r=(a.get(t)||g)(e);void 0!==r?n.set(t,r):n.delete(t)}l.push({key:t,value:e}),r=!0}for(const t of n.keys())s.has(t)||(s.add(t),n.delete(t),i.delete(t),l.push({key:t,value:o.get(t)}),r=!0);for(const{key:t,value:e}of l)y(t,e);return h=!0,r}(r);c=r,s&&d()}function d(){let r=e.encode(n.entries());r&&(r="#"+r),r!==c&&(c=r,t.location.hash=r)}function m(t){const e=n.get(t);if(void 0===e)return o.get(t);const r=l.get(t)||v;let{err:s,value:a}=r(e);return s?void 0:(i.get(t)!==a&&(void 0===a?i.delete(t):i.set(t,a)),void 0===a?o.get(t):a)}function p(t,e=i.get(t)){const r=(a.get(t)||g)(e);n.get(t)!==r&&(void 0===r?n.delete(t):n.set(t,r),d())}function y(t,e){for(const n of u.get(t)||[])n(e)}function g(t){if(!1!==t)return!0===t?"":""+t}function v(t){return s(""===t||"true"===t||"false"!==t&&("null"===t?null:t))}return t.addEventListener("hashchange",(()=>function(e=t.location.hash){h&&e!==c&&f(e)}())),{get encoding(){return e.defaultEncoding},set encoding(t){e.defaultEncoding=t,d()},bind(t,{parse:e=v,stringer:n=g,listener:s,defaultValue:i}){if("string"==typeof i&&(i=r(e(i))),l.set(t,e),a.set(t,n),o.set(t,i),s?u.set(t,[s]):u.delete(t),h){const e=m(t);p(t,e),y(t,e)}},load:f,getStr(t){const e=n.get(t);if(void 0!==e)return e;const r=o.get(t);if(void 0!==r&&"string"!=typeof r){const e=(a.get(t)||g)(r);if(void 0!==e)return e}return""},get:t=>i.get(t),set(t,e){const n=function(t,e){null==e&&o.has(t)&&(e=o.get(t));let n=s(e),r="";"string"==typeof e?(n=(l.get(t)||v)(e),r=e):r=(a.get(t)||g)(e);return{res:n,str:r}}(t,e),{res:{err:r,value:u}}=n;return r||i.get(t)===u||(i.set(t,u),p(t,u),y(t,u)),n},[Symbol.iterator]:()=>i.entries(),stringEntries:()=>n.entries()}}async function d(t,e){const n=t();try{return await async function(t,e){const n=["click","keydown","keyup"];let r=()=>{};function s(){let e=h(t,"h1",HTMLHeadingElement);return e||(e=t.insertBefore(t.ownerDocument.createElement("h1"),t.firstElementChild)),e}function i(){let e=h(t,"#text",HTMLTextAreaElement);return e||(e=t.appendChild(t.ownerDocument.createElement("textarea")),e.id="text"),e}function o(){let e=h(t,"#help",HTMLElement);return e||(e=t.appendChild(t.ownerDocument.createElement("div")),e.id="help",e.classList.add("help")),e}function l(){let e=h(t,"#error",HTMLElement);return e||(e=t.appendChild(t.ownerDocument.createElement("div")),e.id="error",e.classList.add("error")),e}function a({id:e,label:n,title:r}){let s=h(t,`button[id="${e}"]`,HTMLButtonElement);return s||(s=t.appendChild(t.ownerDocument.createElement("button")),s.id=e),s.innerText=n,s.title=r||"",s}function u(){const e=h(t,"h1",HTMLHeadingElement);e&&(e.style.display="none",e.innerText="");const n=h(t,"#text",HTMLTextAreaElement);n&&(n.value="",n.rows=1);const r=h(t,"#help",HTMLElement);r&&(r.style.display="none",r.innerText="");const s=h(t,"#error",HTMLElement);s&&(s.style.display="none",s.innerText="")}function c(){let e=h(t,"#text",HTMLTextAreaElement);if(e){const t=e.value.split(/\n/);e.rows=t.length+1}}let f=0;function d(e){switch(e.type){case"click":{const{target:t}=e;if(t&&t instanceof HTMLButtonElement){const{command:n}=t.dataset;n&&(e.preventDefault(),r({command:n}))}}break;case"keydown":if(e instanceof KeyboardEvent){switch(e.key){case"Enter":const n=h(t,"#text",HTMLTextAreaElement);n&&e.target===n&&e.ctrlKey&&e.preventDefault();break;case"Escape":return e.preventDefault(),void r({canceled:!0})}c()}break;case"keyup":if(e instanceof KeyboardEvent){if("Enter"===e.key){const n=h(t,"#text",HTMLTextAreaElement);if(n&&e.target===n){if(Date.now()-f<1e3||e.ctrlKey)return e.preventDefault(),void r({value:n?n.value.replace(/(?:\r?\n)+$/,""):""});f=Date.now()}}else f=0;c()}}}const y=new Object;try{t.style.display="";for(const e of n)t.addEventListener(e,d);let h=[];for(;;){{const{done:n,value:r}=e.next(h);if(n)return r;const f=r;u();const d=new WeakSet;for(const e of f)if("title"in e){const{title:t}=e,n=s();n.innerText=t,n.style.display=""}else if("value"in e){const{value:t}=e,n=i();n.value=t,c(),n.select(),n.focus()}else if("error"in e){const{error:t}=e;if(t){const e=l();e.innerText=t,e.style.display=""}}else if("help"in e){const{help:t}=e;if(t){const e=o();e.innerText+="string"==typeof t?p(t):m(t),e.style.display=""}}else if("command"in e){const{command:n,label:r=n}=e,s=a({id:`${t.id}$${n}`,label:r});s.dataset.command=n,d.add(s)}else v(e,"unimplemented");for(const e of t.querySelectorAll("button"))d.has(e)||t.removeChild(e)}{h=[];const t=await new Promise((t=>r=t));if(r=()=>{},"canceled"in t)throw y;h.push(t)}}}catch(t){if(t!==y)throw t;return}finally{for(const e of n)t.removeEventListener(e,d);for(t.style.display="none";t.lastChild;)t.removeChild(t.lastChild)}}(n,e)}finally{n.parentNode?.removeChild(n)}}function m(t,e="\n"){let n="";for(const r of t)n+=p(r,e);return n}function p(t,e="\n"){return t.endsWith(e)?t:`${t}${e}`}function y(...t){const e=function(...t){switch(t.length){case 0:return function*(){};case 1:return t[0]}return function*(e){for(const n of t){const t=n(e),{done:r,value:s}=t.next();if(!r)return yield s,yield*t;if(void 0!==s)return s}}}(...t);return function*(){let{values:t,value:n}=g(e([]));for(;void 0===n;){const r=yield t;({values:t,value:n}=g(e(r)))}return n}()}function g(t){const e=[];for(;;){const{done:n,value:r}=t.next();if(n)return{values:e,value:r};e.push(r)}}function v(t,e){throw new Error(`${e}: ${JSON.stringify(t)}`)}a.set("light",((t=0,e=100)=>(0===t&&(t=360),{toString:()=>`light(${t}, ${e})`,makeColorGen(r){const s=t*(1+(r-1)/3)%360;return function*(t){const r=100/(t+1);for(let i=0,o=r;i<t;o+=r,i++)yield n.hsluvToRgb([s,e,o])}}}))),a.set("hue",((t=70,e=40)=>{const n=t>70?-10:10,r=e>70?-10:10;return{toString:()=>`hue(${t}, ${e})`,makeColorGen(s){const i=t+n*s,o=e+r*s;return function*(t){const e=360/t;for(let n=0,r=0;n<t;r+=e,n++)yield[r,i,o]}}}}));class b{constructor(t){this.n=t,this.data=[],this.lastMark=0,this.markWeight=1}mark(){this.markWeight=1,this.lastMark=this.data.length}weightedMark(t){this.lastMark>0&&(this.markWeight*=t),this.lastMark=this.data.length}sinceWeightedMark(){return(this.data.length-this.lastMark)/this.markWeight}sinceMark(){return this.data.length-this.lastMark}reset(){this.data.length=0,this.lastMark=0,this.markWeight=1}complete(){return this.data.length>=this.n}collect(t){for(;this.data.length>=this.n;)this.data.shift();this.data.push(t),this.lastMark>0&&0==--this.lastMark&&(this.markWeight=1)}classifyAnomalies(){const t=this.quantileSelector(),e=t(.25),n=t(.5),r=t(.75),s=r-e,{data:i}=this;if(s/n<.1)return i.map((t=>t/n-1));const o=1.5*s,l=e-o,a=r+o;return i.map((t=>t<l?(t-l)/s:t>a?(t-a)/s:0))}quantileSelector(){const t=[...this.data];return t.sort(((t,e)=>t-e)),e=>{const n=e*t.length;return t[Math.floor(n)]/2+t[Math.ceil(n)]/2}}}class w{constructor(t=0,e=0){this.x=t,this.y=e}type="point.screen";copy(){return new w(this.x,this.y)}copyFrom(t){return this.x=t.x,this.y=t.y,this}toString(){return`ScreenPoint(${this.x}, ${this.y});`}toScreenInto(t){return t.x=this.x,t.y=this.y,t}toScreen(){return this}scale(t){return this.x*=t,this.y*=t,this}mulBy(t,e){return this.x*=t,this.y*=e,this}add(t){return t.type!==this.type&&(t=t.toScreen()),this.x+=t.x,this.y+=t.y,this}addTo(t,e){return this.x+=t,this.y+=e,this}sub(t){return t.type!==this.type&&(t=t.toScreen()),this.x-=t.x,this.y-=t.y,this}}class ${constructor(t=0,e=0,n=0){if(t+e+n!==0)throw new Error(`CubePoint invariant violated: ${t} + ${e} + ${n} = ${t+e+n}`);this.x=t,this.y=e,this.z=n}type="point.cube";toString(){return`CubePoint(${this.x}, ${this.y}, ${this.z})`}copy(){return new $(this.x,this.y,this.z)}copyFrom(t){return t.type!==this.type?t.toCubeInto(this):(this.x=t.x,this.y=t.y,this.z=t.z,this)}add(t){return t.type!==this.type&&(t=t.toCube()),this.x+=t.x,this.y+=t.y,this.z+=t.z,this}addTo(t,e,n){return this.x+=t,this.y+=e,this.z+=n,this}sub(t){return t.type!==this.type&&(t=t.toCube()),this.x-=t.x,this.y-=t.y,this.z-=t.z,this}scale(t){return this.x*=t,this.y*=t,this.z*=t,this}mulBy(t,e,n){return this.x*=t,this.y*=e,this.z*=n,this}toScreenInto(t){return t.x=1.5*this.x,t.y=Math.sqrt(3)*(this.z+this.x/2),t}toScreen(){return this.toScreenInto(new w)}toCubeInto(t){return t.x=this.x,t.y=this.y,t.z=this.z,t}toCube(){return this}toOddQOffset(){const t=this.x,e=this.z+(this.x-(1&this.x))/2;return new T(t,e)}toOddQOffsetInto(t){t.q=this.x,t.r=this.z+(this.x-(1&this.x))/2}static basis=[new $(1,-1,0),new $(0,-1,1),new $(-1,0,1),new $(-1,1,0),new $(0,1,-1),new $(1,0,-1)]}class T{constructor(t=0,e=0){this.q=t,this.r=e}type="offset.odd-q";toString(){return`OddQOffset(${this.q}, ${this.r})`}copy(){return new T(this.q,this.r)}copyFrom(t){return t.toOddQOffsetInto(this),this}add(t){if(t instanceof T){const{q:e,r:n}=t;this.q+=e,this.r+=n}else{const{q:e,r:n}=t.toOddQOffset();this.q+=e,this.r+=n}return this}addTo(t,e){return this.q+=t,this.r+=e,this}sub(t){if(t instanceof T){const{q:e,r:n}=t;this.q-=e,this.r-=n}else{const{q:e,r:n}=t.toOddQOffset();this.q-=e,this.r-=n}return this}scale(t){return this.q*=t,this.r*=t,this}mulBy(t,e){return this.q*=t,this.r*=e,this}toScreenInto(t){return t.x=1.5*this.q,t.y=Math.sqrt(3)*(this.r+.5*(1&this.q)),t}toScreen(){return this.toScreenInto(new w)}toOddQOffset(){return this}toOddQOffsetInto(t){t.q=this.q,t.r=this.r}toCubeInto(t){return t.x=this.q,t.z=this.r-(this.q-(1&this.q))/2,t.y=-t.x-t.z,t}toCube(){return this.toCubeInto(new $)}}class x{constructor(t=new T,e=new T){this.topLeft=t.toOddQOffset(),this.bottomRight=e.toOddQOffset()}copy(){return new x(this.topLeft.copy(),this.bottomRight.copy())}copyFrom(t){return this.topLeft.copyFrom(t.topLeft),this.bottomRight.copyFrom(t.bottomRight),this}toString(){return"OddQBox("+this.topLeft.toString()+", "+this.bottomRight.toString()+")"}screenCount(){return this.screenCountInto(new w)}screenCountInto(t){const e=this.bottomRight.q-this.topLeft.q,n=this.bottomRight.r-this.topLeft.r;return t.x=(3*e+1)/4,t.y=n+(e>1?.5:0),t}contains(t){const e=t.toOddQOffset();return e.q>=this.topLeft.q&&e.q<this.bottomRight.q&&e.r>=this.topLeft.r&&e.r<this.bottomRight.r}expandTo(t){let e=!1;const n=t.toOddQOffset();return n.q<this.topLeft.q?(this.topLeft.q=n.q,e=!0):n.q>=this.bottomRight.q&&(this.bottomRight.q=n.q+1,e=!0),n.r<this.topLeft.r?(this.topLeft.r=n.r,e=!0):n.r>=this.bottomRight.r&&(this.bottomRight.r=n.r+1,e=!0),e}}const S={RelForward:1,RelBackward:2,RelLeft:4,RelRight:8,RelDoubleLeft:16,RelDoubleRight:32,AbsNorthWest:64,AbsNorth:128,AbsNorthEast:256,AbsSouthEast:512,AbsSouth:1024,AbsSouthWest:2048};function*E(t,e){let n=1;for(;n<=32;n<<=1)t&n&&(yield(e+(R.get(n)||0)+6)%6);for(;n<=2048;n<<=1)t&n&&(yield H.get(n)||0)}const R=new Map([[S.RelBackward,3],[S.RelDoubleLeft,-2],[S.RelLeft,-1],[S.RelForward,0],[S.RelRight,1],[S.RelDoubleRight,2]]),H=new Map([[S.AbsSouthEast,0],[S.AbsSouth,1],[S.AbsSouthWest,2],[S.AbsNorthWest,3],[S.AbsNorth,4],[S.AbsNorthEast,5]]);var k,_={exports:{}};k=_,function(t,e){k.exports?k.exports=e():t.nearley=e()}(t,(function(){function t(e,n,r){return this.id=++t.highestId,this.name=e,this.symbols=n,this.postprocess=r,this}function e(t,e,n,r){this.rule=t,this.dot=e,this.reference=n,this.data=[],this.wantedBy=r,this.isComplete=this.dot===t.symbols.length}function n(t,e){this.grammar=t,this.index=e,this.states=[],this.wants={},this.scannable=[],this.completed={}}function r(t,e){this.rules=t,this.start=e||this.rules[0].name;var n=this.byName={};this.rules.forEach((function(t){n.hasOwnProperty(t.name)||(n[t.name]=[]),n[t.name].push(t)}))}function s(){this.reset("")}function i(t,e,i){if(t instanceof r){var o=t;i=e}else o=r.fromCompiled(t,e);for(var l in this.grammar=o,this.options={keepHistory:!1,lexer:o.lexer||new s},i||{})this.options[l]=i[l];this.lexer=this.options.lexer,this.lexerState=void 0;var a=new n(o,0);this.table=[a],a.wants[o.start]=[],a.predict(o.start),a.process(),this.current=0}function o(t){var e=typeof t;if("string"===e)return t;if("object"===e){if(t.literal)return JSON.stringify(t.literal);if(t instanceof RegExp)return t.toString();if(t.type)return"%"+t.type;if(t.test)return"<"+String(t.test)+">";throw new Error("Unknown symbol type: "+t)}}return t.highestId=0,t.prototype.toString=function(t){var e=void 0===t?this.symbols.map(o).join(" "):this.symbols.slice(0,t).map(o).join(" ")+" ● "+this.symbols.slice(t).map(o).join(" ");return this.name+" → "+e},e.prototype.toString=function(){return"{"+this.rule.toString(this.dot)+"}, from: "+(this.reference||0)},e.prototype.nextState=function(t){var n=new e(this.rule,this.dot+1,this.reference,this.wantedBy);return n.left=this,n.right=t,n.isComplete&&(n.data=n.build(),n.right=void 0),n},e.prototype.build=function(){var t=[],e=this;do{t.push(e.right.data),e=e.left}while(e.left);return t.reverse(),t},e.prototype.finish=function(){this.rule.postprocess&&(this.data=this.rule.postprocess(this.data,this.reference,i.fail))},n.prototype.process=function(t){for(var e=this.states,n=this.wants,r=this.completed,s=0;s<e.length;s++){var o=e[s];if(o.isComplete){if(o.finish(),o.data!==i.fail){for(var l=o.wantedBy,a=l.length;a--;){var u=l[a];this.complete(u,o)}if(o.reference===this.index){var c=o.rule.name;(this.completed[c]=this.completed[c]||[]).push(o)}}}else{if("string"!=typeof(c=o.rule.symbols[o.dot])){this.scannable.push(o);continue}if(n[c]){if(n[c].push(o),r.hasOwnProperty(c)){var h=r[c];for(a=0;a<h.length;a++){var f=h[a];this.complete(o,f)}}}else n[c]=[o],this.predict(c)}}},n.prototype.predict=function(t){for(var n=this.grammar.byName[t]||[],r=0;r<n.length;r++){var s=n[r],i=this.wants[t],o=new e(s,0,this.index,i);this.states.push(o)}},n.prototype.complete=function(t,e){var n=t.nextState(e);this.states.push(n)},r.fromCompiled=function(e,n){var s=e.Lexer;e.ParserStart&&(n=e.ParserStart,e=e.ParserRules);var i=new r(e=e.map((function(e){return new t(e.name,e.symbols,e.postprocess)})),n);return i.lexer=s,i},s.prototype.reset=function(t,e){this.buffer=t,this.index=0,this.line=e?e.line:1,this.lastLineBreak=e?-e.col:0},s.prototype.next=function(){if(this.index<this.buffer.length){var t=this.buffer[this.index++];return"\n"===t&&(this.line+=1,this.lastLineBreak=this.index),{value:t}}},s.prototype.save=function(){return{line:this.line,col:this.index-this.lastLineBreak}},s.prototype.formatError=function(t,e){var n=this.buffer;if("string"==typeof n){var r=n.split("\n").slice(Math.max(0,this.line-5),this.line);n.indexOf("\n",this.index);var s=this.index-this.lastLineBreak,i=String(this.line).length;return e+=" at line "+this.line+" col "+s+":\n\n",e+=r.map((function(t,e){return o(this.line-r.length+e+1,i)+" "+t}),this).join("\n"),e+="\n"+o("",i+s)+"^\n"}return e+" at index "+(this.index-1);function o(t,e){var n=String(t);return Array(e-n.length+1).join(" ")+n}},i.fail={},i.prototype.feed=function(t){var e,r=this.lexer;for(r.reset(t,this.lexerState);;){try{if(!(e=r.next()))break}catch(t){var i=new n(this.grammar,this.current+1);throw this.table.push(i),(a=new Error(this.reportLexerError(t))).offset=this.current,a.token=t.token,a}var o=this.table[this.current];this.options.keepHistory||delete this.table[this.current-1];var l=this.current+1;i=new n(this.grammar,l),this.table.push(i);for(var a,u=void 0!==e.text?e.text:e.value,c=r.constructor===s?e.value:e,h=o.scannable,f=h.length;f--;){var d=h[f],m=d.rule.symbols[d.dot];if(m.test?m.test(c):m.type?m.type===e.type:m.literal===u){var p=d.nextState({data:c,token:e,isToken:!0,reference:l-1});i.states.push(p)}}if(i.process(),0===i.states.length)throw(a=new Error(this.reportError(e))).offset=this.current,a.token=e,a;this.options.keepHistory&&(o.lexerState=r.save()),this.current++}return o&&(this.lexerState=r.save()),this.results=this.finish(),this},i.prototype.reportLexerError=function(t){var e,n,r=t.token;return r?(e="input "+JSON.stringify(r.text[0])+" (lexer error)",n=this.lexer.formatError(r,"Syntax error")):(e="input (lexer error)",n=t.message),this.reportErrorCommon(n,e)},i.prototype.reportError=function(t){var e=(t.type?t.type+" token: ":"")+JSON.stringify(void 0!==t.value?t.value:t),n=this.lexer.formatError(t,"Syntax error");return this.reportErrorCommon(n,e)},i.prototype.reportErrorCommon=function(t,e){var n=[];n.push(t);var r=this.table.length-2,s=this.table[r],i=s.states.filter((function(t){var e=t.rule.symbols[t.dot];return e&&"string"!=typeof e}));return 0===i.length?(n.push("Unexpected "+e+". I did not expect any more input. Here is the state of my parse table:\n"),this.displayStateStack(s.states,n)):(n.push("Unexpected "+e+". Instead, I was expecting to see one of the following:\n"),i.map((function(t){return this.buildFirstStateStack(t,[])||[t]}),this).forEach((function(t){var e=t[0],r=e.rule.symbols[e.dot],s=this.getSymbolDisplay(r);n.push("A "+s+" based on:"),this.displayStateStack(t,n)}),this)),n.push(""),n.join("\n")},i.prototype.displayStateStack=function(t,e){for(var n,r=0,s=0;s<t.length;s++){var i=t[s],o=i.rule.toString(i.dot);o===n?r++:(r>0&&e.push("    ^ "+r+" more lines identical to this"),r=0,e.push("    "+o)),n=o}},i.prototype.getSymbolDisplay=function(t){return function(t){var e=typeof t;if("string"===e)return t;if("object"===e){if(t.literal)return JSON.stringify(t.literal);if(t instanceof RegExp)return"character matching "+t;if(t.type)return t.type+" token";if(t.test)return"token matching "+String(t.test);throw new Error("Unknown symbol type: "+t)}}(t)},i.prototype.buildFirstStateStack=function(t,e){if(-1!==e.indexOf(t))return null;if(0===t.wantedBy.length)return[t];var n=t.wantedBy[0],r=[t].concat(e),s=this.buildFirstStateStack(n,r);return null===s?null:[t].concat(s)},i.prototype.save=function(){var t=this.table[this.current];return t.lexerState=this.lexerState,t},i.prototype.restore=function(t){var e=t.index;this.current=e,this.table[e]=t,this.table.splice(e+1),this.lexerState=t.lexerState,this.results=this.finish()},i.prototype.rewind=function(t){if(!this.options.keepHistory)throw new Error("set option `keepHistory` to enable rewinding");this.restore(this.table[t])},i.prototype.finish=function(){var t=[],e=this.grammar.start;return this.table[this.table.length-1].states.forEach((function(n){n.rule.name===e&&n.dot===n.rule.symbols.length&&0===n.reference&&n.data!==i.fail&&t.push(n)})),t.map((function(t){return t.data}))},{Parser:i,Grammar:r,Rule:t}}));var M=_.exports;let C,A=[{name:"spec",symbols:["entries"],postprocess:([t])=>({type:"spec",entries:t||[]})},{name:"entries",symbols:["entry"]},{name:"entries",symbols:["entry","newline","entries"],postprocess:([t,e,n])=>[t].concat(n)},{name:"comment$string$1",symbols:[{literal:"-"},{literal:"-"}],postprocess:function(t){return t.join("")}},{name:"comment$macrocall$2",symbols:[/[^\n]/]},{name:"comment$macrocall$1$ebnf$1",symbols:["comment$macrocall$2"]},{name:"comment$macrocall$1$ebnf$1",symbols:["comment$macrocall$1$ebnf$1","comment$macrocall$2"],postprocess:function(t){return t[0].concat([t[1]])}},{name:"comment$macrocall$1",symbols:["comment$macrocall$1$ebnf$1"],postprocess:([t])=>t.join("")},{name:"comment",symbols:["_","comment$string$1","comment$macrocall$1"],postprocess:([t,e,n])=>({type:"comment",comment:n})},{name:"entry",symbols:["assign"],postprocess:t=>t[0]},{name:"entry",symbols:["rule"],postprocess:t=>t[0]},{name:"entry",symbols:["directive"],postprocess:t=>t[0]},{name:"entry",symbols:["comment"],postprocess:t=>t[0]},{name:"directive$macrocall$2",symbols:[/[\w]/]},{name:"directive$macrocall$1$ebnf$1",symbols:["directive$macrocall$2"]},{name:"directive$macrocall$1$ebnf$1",symbols:["directive$macrocall$1$ebnf$1","directive$macrocall$2"],postprocess:function(t){return t[0].concat([t[1]])}},{name:"directive$macrocall$1",symbols:["directive$macrocall$1$ebnf$1"],postprocess:([t])=>t.join("")},{name:"directive$macrocall$4",symbols:[/[^\n]/]},{name:"directive$macrocall$3$ebnf$1",symbols:["directive$macrocall$4"]},{name:"directive$macrocall$3$ebnf$1",symbols:["directive$macrocall$3$ebnf$1","directive$macrocall$4"],postprocess:function(t){return t[0].concat([t[1]])}},{name:"directive$macrocall$3",symbols:["directive$macrocall$3$ebnf$1"],postprocess:([t])=>t.join("")},{name:"directive",symbols:["_",{literal:"@"},"directive$macrocall$1","__","directive$macrocall$3"],postprocess:([t,e,n,r,s])=>({type:"directive",name:n,value:s})},{name:"assign",symbols:["identifier","_",{literal:"="},"_","lit"],postprocess:([t,e,n,r,s])=>({type:"assign",id:t,value:s})},{name:"rule",symbols:["ant"],postprocess:([t])=>t},{name:"rule$string$1",symbols:[{literal:"="},{literal:">"}],postprocess:function(t){return t.join("")}},{name:"rule",symbols:["when","rule$string$1","then"],postprocess:([t,e,n])=>({type:"rule",when:t,then:n})},{name:"when",symbols:["expr",{literal:","},"expr"],postprocess:([t,e,n])=>({type:"when",state:t,color:n})},{name:"then",symbols:["thenState",{literal:","},"thenColor",{literal:","},"thenTurn"],postprocess:([t,e,n,r,s])=>({type:"then",state:t,color:n,turn:s})},{name:"thenMode",symbols:[],postprocess:()=>"="},{name:"thenMode",symbols:[{literal:"="}],postprocess:()=>"="},{name:"thenMode",symbols:[{literal:"|"}],postprocess:()=>"|"},{name:"thenNoop",symbols:["_",{literal:"_"},"_"],postprocess:()=>({type:"thenVal",mode:"_"})},{name:"thenState",symbols:["thenNoop"],postprocess:t=>t[0]},{name:"thenState",symbols:["_","thenMode","sum","_"],postprocess:([t,e,n])=>({type:"thenVal",mode:e,value:n})},{name:"thenColor",symbols:["thenNoop"],postprocess:t=>t[0]},{name:"thenColor",symbols:["_","thenMode","sum","_"],postprocess:([t,e,n])=>({type:"thenVal",mode:e,value:n})},{name:"thenTurn",symbols:["thenNoop"],postprocess:t=>t[0]},{name:"thenTurn",symbols:["_","thenMode","sum","_"],postprocess:([t,e,n])=>({type:"thenVal",mode:e,value:n})},{name:"thenTurn",symbols:["_","thenMode","turnExpr","_"],postprocess:([t,e,n])=>({type:"thenVal",mode:e,value:n})},{name:"turnExpr",symbols:["turn"],postprocess:([t])=>({type:"turn",names:[t]})},{name:"turnExpr",symbols:["turnExpr",{literal:"|"},"turnExpr"],postprocess:([t,e,n])=>({type:"turn",names:t.names.concat(n.names)})},{name:"expr",symbols:["_","sum","_"],postprocess:t=>t[1]},{name:"sumop",symbols:["_",{literal:"+"},"_"],postprocess:t=>t[1]},{name:"sumop",symbols:["_",{literal:"-"},"_"],postprocess:t=>t[1]},{name:"mulop",symbols:["_",{literal:"*"},"_"],postprocess:t=>t[1]},{name:"mulop",symbols:["_",{literal:"/"},"_"],postprocess:t=>t[1]},{name:"mulop",symbols:["_",{literal:"%"},"_"],postprocess:t=>t[1]},{name:"sum",symbols:["sum","sumop","mul"],postprocess:([t,e,n])=>({type:"expr",op:e,arg1:t,arg2:n})},{name:"sum",symbols:["mul"],postprocess:t=>t[0]},{name:"mul",symbols:["mul","mulop","fac"],postprocess:([t,e,n])=>({type:"expr",op:e,arg1:t,arg2:n})},{name:"mul",symbols:["fac"],postprocess:t=>t[0]},{name:"fac",symbols:[{literal:"("},"expr",{literal:")"}],postprocess:t=>t[1]},{name:"fac",symbols:["lit"],postprocess:t=>t[0]},{name:"fac",symbols:["member"],postprocess:t=>t[0]},{name:"fac",symbols:["symbol"],postprocess:t=>t[0]},{name:"fac",symbols:["identifier"],postprocess:t=>t[0]},{name:"ant$string$1",symbols:[{literal:"a"},{literal:"n"},{literal:"t"},{literal:"("}],postprocess:function(t){return t.join("")}},{name:"ant",symbols:["_","ant$string$1","countTurns",{literal:")"},"_"],postprocess:([t,e,n])=>({type:"ant",turns:n})},{name:"turns$string$1",symbols:[{literal:"t"},{literal:"u"},{literal:"r"},{literal:"n"},{literal:"s"},{literal:"("}],postprocess:function(t){return t.join("")}},{name:"turns",symbols:["turns$string$1","countTurns",{literal:")"}],postprocess:([t,e])=>({type:"turns",turns:e})},{name:"turn",symbols:[{literal:"L"}],postprocess:()=>"RelLeft"},{name:"turn",symbols:[{literal:"R"}],postprocess:()=>"RelRight"},{name:"turn",symbols:[{literal:"F"}],postprocess:()=>"RelForward"},{name:"turn",symbols:[{literal:"B"}],postprocess:()=>"RelBackward"},{name:"turn",symbols:[{literal:"P"}],postprocess:()=>"RelDoubleLeft"},{name:"turn",symbols:[{literal:"S"}],postprocess:()=>"RelDoubleRight"},{name:"turn",symbols:[{literal:"l"}],postprocess:()=>"RelLeft"},{name:"turn",symbols:[{literal:"r"}],postprocess:()=>"RelRight"},{name:"turn",symbols:[{literal:"f"}],postprocess:()=>"RelForward"},{name:"turn",symbols:[{literal:"b"}],postprocess:()=>"RelBackward"},{name:"turn",symbols:[{literal:"p"}],postprocess:()=>"RelDoubleLeft"},{name:"turn",symbols:[{literal:"s"}],postprocess:()=>"RelDoubleRight"},{name:"turn$string$1",symbols:[{literal:"N"},{literal:"W"}],postprocess:function(t){return t.join("")}},{name:"turn",symbols:["turn$string$1"],postprocess:()=>"AbsNorthWest"},{name:"turn$string$2",symbols:[{literal:"N"},{literal:"O"}],postprocess:function(t){return t.join("")}},{name:"turn",symbols:["turn$string$2"],postprocess:()=>"AbsNorth"},{name:"turn$string$3",symbols:[{literal:"N"},{literal:"E"}],postprocess:function(t){return t.join("")}},{name:"turn",symbols:["turn$string$3"],postprocess:()=>"AbsNorthEast"},{name:"turn$string$4",symbols:[{literal:"S"},{literal:"E"}],postprocess:function(t){return t.join("")}},{name:"turn",symbols:["turn$string$4"],postprocess:()=>"AbsSouthEast"},{name:"turn$string$5",symbols:[{literal:"S"},{literal:"O"}],postprocess:function(t){return t.join("")}},{name:"turn",symbols:["turn$string$5"],postprocess:()=>"AbsSouth"},{name:"turn$string$6",symbols:[{literal:"S"},{literal:"W"}],postprocess:function(t){return t.join("")}},{name:"turn",symbols:["turn$string$6"],postprocess:()=>"AbsSouthWest"},{name:"turn$string$7",symbols:[{literal:"n"},{literal:"w"}],postprocess:function(t){return t.join("")}},{name:"turn",symbols:["turn$string$7"],postprocess:()=>"AbsNorthWest"},{name:"turn$string$8",symbols:[{literal:"n"},{literal:"o"}],postprocess:function(t){return t.join("")}},{name:"turn",symbols:["turn$string$8"],postprocess:()=>"AbsNorth"},{name:"turn$string$9",symbols:[{literal:"n"},{literal:"e"}],postprocess:function(t){return t.join("")}},{name:"turn",symbols:["turn$string$9"],postprocess:()=>"AbsNorthEast"},{name:"turn$string$10",symbols:[{literal:"s"},{literal:"e"}],postprocess:function(t){return t.join("")}},{name:"turn",symbols:["turn$string$10"],postprocess:()=>"AbsSouthEast"},{name:"turn$string$11",symbols:[{literal:"s"},{literal:"o"}],postprocess:function(t){return t.join("")}},{name:"turn",symbols:["turn$string$11"],postprocess:()=>"AbsSouth"},{name:"turn$string$12",symbols:[{literal:"s"},{literal:"w"}],postprocess:function(t){return t.join("")}},{name:"turn",symbols:["turn$string$12"],postprocess:()=>"AbsSouthWest"},{name:"countTurn",symbols:["turn"],postprocess:([t])=>({count:{type:"number",value:1},turn:t})},{name:"countTurn",symbols:["decint","turn"],postprocess:([t,e])=>({count:t,turn:e})},{name:"countTurns$ebnf$1",symbols:[]},{name:"countTurns$ebnf$1$subexpression$1",symbols:["__","countTurn"]},{name:"countTurns$ebnf$1",symbols:["countTurns$ebnf$1","countTurns$ebnf$1$subexpression$1"],postprocess:function(t){return t[0].concat([t[1]])}},{name:"countTurns",symbols:["_","countTurn","countTurns$ebnf$1","_"],postprocess:([t,e,n=[]])=>[e,...n.map((([t,e])=>e))]},{name:"member$subexpression$1",symbols:["member"]},{name:"member$subexpression$1",symbols:["symbol"]},{name:"member$subexpression$1",symbols:["identifier"]},{name:"member$subexpression$1",symbols:["lit"]},{name:"member",symbols:["member$subexpression$1",{literal:"["},"expr",{literal:"]"}],postprocess:([[t],e,n])=>({type:"member",value:t,item:n})},{name:"symbol$ebnf$1",symbols:[]},{name:"symbol$ebnf$1",symbols:["symbol$ebnf$1",/[\w]/],postprocess:function(t){return t[0].concat([t[1]])}},{name:"symbol",symbols:[/[a-z]/,"symbol$ebnf$1"],postprocess:([t,e])=>({type:"symbol",name:t+e.join("")})},{name:"identifier$ebnf$1",symbols:[/[\w]/]},{name:"identifier$ebnf$1",symbols:["identifier$ebnf$1",/[\w]/],postprocess:function(t){return t[0].concat([t[1]])}},{name:"identifier",symbols:[/[A-Z]/,"identifier$ebnf$1"],postprocess:([t,e])=>({type:"identifier",name:t+e.join("")})},{name:"lit",symbols:["int"],postprocess:t=>t[0]},{name:"lit",symbols:["turns"],postprocess:t=>t[0]},{name:"int$string$1",symbols:[{literal:"0"},{literal:"x"}],postprocess:function(t){return t.join("")}},{name:"int",symbols:["int$string$1","hexint"],postprocess:t=>t[1]},{name:"int",symbols:["decint"],postprocess:t=>t[0]},{name:"hexint$macrocall$2",symbols:[/[0-9a-fA-F]/]},{name:"hexint$macrocall$1$ebnf$1",symbols:["hexint$macrocall$2"]},{name:"hexint$macrocall$1$ebnf$1",symbols:["hexint$macrocall$1$ebnf$1","hexint$macrocall$2"],postprocess:function(t){return t[0].concat([t[1]])}},{name:"hexint$macrocall$1",symbols:["hexint$macrocall$1$ebnf$1"],postprocess:([t])=>t.join("")},{name:"hexint",symbols:["hexint$macrocall$1"],postprocess:([t])=>({type:"number",value:parseInt(t,16),base:16})},{name:"decint$macrocall$2",symbols:[/[0-9]/]},{name:"decint$macrocall$1$ebnf$1",symbols:["decint$macrocall$2"]},{name:"decint$macrocall$1$ebnf$1",symbols:["decint$macrocall$1$ebnf$1","decint$macrocall$2"],postprocess:function(t){return t[0].concat([t[1]])}},{name:"decint$macrocall$1",symbols:["decint$macrocall$1$ebnf$1"],postprocess:([t])=>t.join("")},{name:"decint",symbols:["decint$macrocall$1"],postprocess:([t])=>({type:"number",value:parseInt(t,10)})},{name:"_$ebnf$1",symbols:[]},{name:"_$ebnf$1",symbols:["_$ebnf$1",/[\s]/],postprocess:function(t){return t[0].concat([t[1]])}},{name:"_",symbols:["_$ebnf$1"],postprocess:()=>null},{name:"__$ebnf$1",symbols:[/[\s]/]},{name:"__$ebnf$1",symbols:["__$ebnf$1",/[\s]/],postprocess:function(t){return t[0].concat([t[1]])}},{name:"__",symbols:["__$ebnf$1"],postprocess:()=>null},{name:"newline$ebnf$1",symbols:[{literal:"\r"}],postprocess:function(t){return t[0]}},{name:"newline$ebnf$1",symbols:[],postprocess:function(t){return null}},{name:"newline",symbols:["newline$ebnf$1",{literal:"\n"}],postprocess:()=>null}];var L={Lexer:C,ParserRules:A,ParserStart:"spec"};function B(t,e){return e.type===t}function N(t,e){return{type:"number",value:t,base:e}}function q(t,e){return"string"==typeof t&&(t={type:"identifier",name:t}),{type:"assign",id:t,value:e}}function P(t,e){return{type:"rule",when:t,then:e}}function F(t,e){return{type:"member",value:t,item:e}}function O(t,e,n){return{type:"expr",op:t,arg1:e,arg2:n}}function I(t,e){return{type:"when",state:t,color:e}}function z(t,e,n){return{type:"then",state:W(t),color:W(e),turn:W(n)}}function W(t,e="="){return"thenVal"===t.type?t:{type:"thenVal",mode:e,value:t}}function D(t){return{type:"thenVal",mode:"=",value:t}}function U(t){return"expr"===t.type||j(t)}function j(t){switch(t.type){case"member":case"symbol":case"identifier":case"number":case"turns":return!0;default:return!1}}const V=M.Grammar.fromCompiled(L);function G(t){return"string"!=typeof t?i(new Error("invalid argument, not a string")):o((()=>{const e=new M.Parser(V);e.feed(t);const{results:n}=e;switch(n.length){case 0:return i(new Error("no parse result"));case 1:return s(function(t,e){if(!B(t,e))throw new Error(`expected a ${JSON.stringify(t)} grammar node, got a ${JSON.stringify(t)} node`);return e}("spec",n[0]));default:return i(new Error("ambiguous parse"))}}))}function Q(t){const{consume:e,finish:n}=function(){let t=[],e="",n=0;return{consume(r,s){if(void 0===s){if("string"!=typeof r)return;const t=/(\d*)(\w+)/.exec(r);if(!t)return;r=t[1],s=t[2]}"string"==typeof r&&(r=parseInt(r),isNaN(r)&&(r=1)),e!==s&&(e&&n&&t.push([n,e]),e=s,n=0),n+=r},finish(){e&&n&&t.push([n,e]);const r=t;return t=[],e="",n=0,r}}}();for(const[n,r]of t)e(n,r);return n()}const Y={RelLeft:"L",RelRight:"R",RelForward:"F",RelBackward:"B",RelDoubleLeft:"P",RelDoubleRight:"S",AbsNorth:"NO",AbsNorthWest:"NW",AbsNorthEast:"NE",AbsSouth:"SO",AbsSouthEast:"SE",AbsSouthWest:"SW"},X=["+","-","*","/","%"];function*K(...t){yield*J(0,...t)}function*J(t,...e){for(const n of e)switch(n.type){case"spec":{const{entries:e}=n;for(const n of e)yield*J(t,n);break}case"comment":{const{comment:t}=n;yield`--${t}`;break}case"directive":{const{name:t,value:e}=n;yield`@${t} ${e}`;break}case"assign":{const{id:{name:e},value:r}=n,s=J(t,r);yield`${e} = ${Z(s,"")}`,yield*s;break}case"rule":{const{when:e,then:r}=n,s=J(t,e,r);yield`${Z(s,"")} => ${Z(s,"")}`,yield*s;break}case"when":{const{state:e,color:r}=n,s=J(t,e,r);yield`${Z(s,"")}, ${Z(s,"")}`,yield*s;break}case"then":const{state:e,color:r,turn:s}=n,i=J(t,e,r,s);yield`${Z(i,"")}, ${Z(i,"")}, ${Z(i,"")}`,yield*i;break;case"thenVal":{const{mode:e}=n;if("_"===e){yield"_";break}const{value:r}=n,s=J(t,r);yield`${"="===e?"":e}${Z(s,"")}`,yield*s;break}case"member":{const{value:e,item:r}=n,s=J(t,e,r);yield`${Z(s,"")}[${Z(s,"")}]`,yield*s;break}case"expr":{const{op:e,arg1:r,arg2:s}=n,i=X.indexOf(e),o=J(t,r,s),l=`${Z(o,"")} ${e} ${Z(o,"")}`;yield i<t?`(${l})`:l,yield*o;break}case"identifier":case"symbol":{const{name:t}=n;yield t;break}case"ant":case"turns":{const{type:t,turns:e}=n;yield`${t}(${Q(e.map((({count:{value:t},turn:e})=>[t,Y[e]]))).map((([t,e])=>t>1?`${t}${e}`:e)).join(" ")})`;break}case"turn":{const{names:t}=n;yield t.map((t=>Y[t])).join("|");break}case"number":{const{value:t,base:e}=n;yield t.toString(e);break}default:tt(n,"invalid grammar node")}}function Z(t,e){const{done:n,value:r}=t.next();return n?e:r}function tt(t,e){throw new Error(`${e}: ${JSON.stringify(t)}`)}function et(t,{state:e=0,whenState:n=N(e),thenState:r=D(N(e))}={}){const s={type:"symbol",name:"c"};return P(I(n,s),z(r,O("+",s,N(1)),F(function(...t){return{type:"turns",turns:t}}(...t),s)))}function nt(t,e){return n=>B(t,n)?e(n):void 0}function rt(t,...e){const n=t.type;const r=st(t,...e);if(null===r)return null;if(!r)return t;if(r.type!==n)throw new Error("invalid replacement node");return r}function st(t,...e){if(!e.length)return t;const n=e.length>1?t=>{for(const n of e)t=n(t)||t;return t}:e[0];return r(t);function r(t){let e=n(t);if(null===e)return null;e&&e!==t&&(e=r(e)||e);const s=function(t){switch(t.type){case"spec":{let e=!1;const n=t.entries.map((t=>{const n=r(t);if(n&&!function(t){switch(t.type){case"ant":case"assign":case"comment":case"directive":case"rule":return!0;default:return!1}}(n))throw new Error("invalid replacement spec entry");return void 0===n?t:(e=e||n!==t,n)})).filter(it);return e?n.length?function(...t){return{type:"spec",entries:t}}(...n):null:void 0}case"assign":{let e=r(t.id),n=r(t.value);if(null===e||null===n)return null;if(!e&&!n)return;if(e){if("identifier"!==e.type)throw new Error("invalid replacement identifier node")}else e=t.id;if(n){if(!U(n))throw new Error("invalid replacement value node")}else n=t.value;return q(e,n)}case"rule":{let e=r(t.when),n=r(t.then);if(null===e||null===n)return null;if(!e&&!n)return;if(e){if("when"!==e.type)throw new Error("invalid replacement when node")}else e=t.when;if(n){if("then"!==n.type)throw new Error("invalid replacement then node")}else n=t.then;return P(e,n)}case"when":{let e=r(t.state),n=r(t.color);if(null===e||null===n)return null;if(!e&&!n)return;if(e){if(!U(e))throw new Error("invalid replacement when.state node")}else e=t.state;if(n){if(!U(n))throw new Error("invalid replacement when.color node")}else n=t.color;return I(e,n)}case"then":{let e=r(t.state),n=r(t.color),s=r(t.turn);if(null===e&&(e={type:"thenVal",mode:"_"}),null===n&&(n={type:"thenVal",mode:"_"}),null===s&&(s={type:"thenVal",mode:"_"}),!e&&!n&&!s)return;if(e){if("thenVal"!==e.type)throw new Error("invalid replacement then.state node")}else e=t.state;if(n){if("thenVal"!==n.type)throw new Error("invalid replacement then.color node")}else n=t.color;if(s){if("thenVal"!==s.type)throw new Error("invalid replacement then.turn node")}else s=t.turn;return"_"===e.mode&&"_"===n.mode&&"_"===s.mode?null:z(e,n,s)}case"thenVal":{const{mode:e}=t;if("_"==e)return;let n=r(t.value);if(null===n)return null;if(!n)return;if(!U(n))throw new Error("invalid replacement then value node");return W(n,e)}case"member":{let e=r(t.item),n=r(t.value);if(null===e||null===n)return null;if(!e&&!n)return;if(e){if(!U(e))throw new Error("invalid replacement item node")}else e=t.item;if(n){if(!j(n))throw new Error("invalid replacement value node")}else n=t.value;return F(n,e)}case"expr":{const{op:e}=t;let n=r(t.arg1),s=r(t.arg2);if(null===n||null===s)return null;if(!n&&!s)return;if(n){if(!U(n))throw new Error("invalid replacement arg1 node")}else n=t.arg1;if(s){if(!U(s))throw new Error("invalid replacement arg2 node")}else s=t.arg2;return O(e,n,s)}case"ant":case"comment":case"directive":case"identifier":case"number":case"symbol":case"turn":case"turns":return;default:return void function(t,e){throw new Error(`${e}: ${JSON.stringify(t)}`)}(t,"invalid transform node")}}(t=e||t);return void 0===s?t:s}}function it(t){return null!==t}const ot=["+","-","*","/","%"];function lt(t){const e=function(t,{format:e="value"}={}){const n=function(){const t=[];let e=new Set;function n(){t.push(e),e=new Set([...e])}function r(){e=t.pop()||new Set}return{push:n,pop:r,[Symbol.iterator]:()=>e[Symbol.iterator](),has:t=>e.has(t),define(...t){for(const n of t){if(e.has(n))throw new Error(`redefinition of symbol ${n}`);e.add(n)}},gen(t){for(let n=1;;n++){const r=t+n;if(!e.has(r))return r}},*block(t){n(),yield*function*(...t){yield*function*({head:t="",foot:e="",cont:n="",zero:r="undefined"},...s){t&&(yield t);let i=!1;for(const t of mt(...s))yield n?`${n}${t}`:t,i=!0;!i&&r&&(yield r);e&&(yield e)}({head:"{",cont:"  ",foot:"}"},...t)}(t()),r()}}}();return r(t);function*r(t){switch(e){case"value":yield*function(t,e,n){const r=e.map((t=>{const e=/^(\w+)\s*=.*$/.exec(t);return e?e[1]:t}));return dt(`(${e.join(", ")}) => `,t.block((function*(){t.define(...r),yield*n()})))}(n,["_rules","World"],(function*(){yield*s(t),yield*o(t)}));break;case"module":yield*s(t),yield*function(t,e,n,r){const s=n.map((t=>{const e=/^(\w+)\s*=.*$/.exec(t);return e?e[1]:t}));let i="function";const o=e.lastIndexOf(" ");o>=0&&(i=`${e.slice(o)} ${i}`,e=e.slice(o+1));e.startsWith("*")&&(i=`${i}*`,e=e.slice(1));e&&(t.define(e),i=`${i} ${e}`);return dt(`${i}(${n.join(", ")}) `,t.block((function*(){t.define(...s),yield*r()})))}(n,"export default build",["_rules","World"],(function*(){yield*o(t)}));break;default:pt(e,"invalid format")}}function*s(t){n.define("specString"),yield*dt({head:"const specString = ",cont:"  ",zero:"''",foot:";"},function*(t){let e="";for(const n of t)e&&(yield`${e} +`),e=JSON.stringify(n+"\n");e&&(yield e)}(K(t))),yield"",n.define("numColors"),yield`const numColors = ${function(t){let e=0;return st(t,(t=>{switch(t.type){case"directive":{const{name:n,value:r}=t;if("numColors"!==n)return;const s=parseInt(r);isNaN(s)||(e=Math.max(e,s));break}case"ant":case"turns":{const{turns:n}=t;e=Math.max(e,n.length);break}}})),e}(t)};`,yield""}function*i(t,e){let n=K(t);e&&(n=dt(e,n)),yield*ht(n)}function*o(t){yield"if (numColors > World.MaxColor+1) return {err: `required numColors:${numColors} exceeds world max:(${World.MaxColor})`};",yield"",n.define("_states"),yield"const _states = new Set();",yield"";for(const e of t.entries)switch(e.type){case"comment":yield*ht([e.comment.trimStart()]);break;case"directive":yield*ht([`@${e.name} ${e.value.trimStart()}`]);break;case"assign":yield"",yield*i(e,{head:"assign: "}),yield*l(e);break;case"ant":yield"",yield*i(e,{head:"rule: "}),yield*a(et(e.turns));break;case"rule":yield"",yield*i(e,{head:"rule: "}),yield*a(e);break;default:pt(e,"invalid rule node")}yield"return {value: {specString, numColors, numStates: _states.size}};"}function*l({id:{name:t},value:e}){n.define(t),yield`let ${t} = ${at(n,e)};`}function*a(t){yield*n.block((function*(){const e=[],r=rt(t,nt("member",(({value:t,item:r})=>{switch(t.type){case"symbol":case"identifier":return;default:const{type:s}=t,i=n.gen(`${s[0].toUpperCase()}${s.slice(1)}`);return e.push(q(i,t)),F(function(t){return{type:"identifier",name:t}}(i),r)}})));if(!r)return void(yield*ht(["eliminated by transform",...JSON.stringify(t,null,2).split(/\n/)]));const{when:s,then:i}=r;for(const t of e)yield*l(t);yield*u(s,i)}))}function*u({state:t,color:e},{state:r,color:s,turn:o}){const l=[{name:"state",then:r,mask:"World.MaskResultState",max:"World.MaxState",shift:"World.ColorShift"},{name:"color",then:s,mask:"World.MaskResultColor",max:"World.MaxColor",shift:"World.TurnShift"},{name:"turn",then:o,mask:"World.MaskResultTurn",max:"World.MaxTurn"}].map((({then:t,...e})=>{let n=!0;const{mode:r}=t;if("_"!==r){const{value:e}=t;n="|"===r&&"0"===at({has:()=>!0},e,ot.length)}return{then:t,isEmpty:n,...e}}));if(l.every((({isEmpty:t})=>t)))return;const a=[{when:t,name:"state",cap:"_state",sym:"_stateKey",shift:"World.ColorShift",max:"World.MaxState",init:t=>`_states.add(${t});`},{when:e,name:"color",cap:"_color",sym:"_colorKey",max:"World.MaxColor"}];{const t=l.map((({then:{mode:t},mask:e})=>"="===t?e:"")).filter((t=>t));switch(t.length){case 0:break;case 1:n.define("_priorMask"),yield`const _priorMask = ~${t[0]};`,yield"";break;default:n.define("_priorMask"),yield`const _priorMask = ~(${t.reduce(((t,e)=>`${t}${t?" | ":""}${e}`))});`,yield""}}function*u(t,e=""){if(t<a.length){const{name:r,when:s,cap:o,sym:l,shift:c,max:h,init:f}=a[t],d=function*(){let r=o;c?(e&&(r=`(${e} | ${r})`),r=`${r} << ${c}`):e&&(r=`${e} | ${r}`),n.define(l),yield`const ${l} = ${r};`,f&&(yield f(o)),yield"",yield*u(t+1,l)};switch(yield*i(s,{head:`when ${r} matches: `}),s.type){case"symbol":case"expr":yield*dt(`for (let ${o} = 0; ${o} <= ${h}; ${o}++) `,n.block((function*(){n.define(o);const t=[...ut(s,n)];if(t.length>1)throw new Error("matching more than one variable is unsupported");const e=t[0];if(!e)throw new Error("no match variable");n.define(e);const r=function(t,e,n,r,s=0){const i={"+":"-","*":"/","-":"+","/":"*"},o=[n,...u(r)],l=(t=0)=>{const e=o.pop();if(!e)return"undefined";const n=ot.indexOf(e);if(n>=0){const r=l(n),s=l(n);return n<t?`(${s} ${e} ${r})`:`${s} ${e} ${r}`}return e},a=l(s);if(o.length)throw new Error("leftover solution stack");return a;function*u(n){switch(n.type){case"expr":const{op:t,arg1:r,arg2:s}=n,o=ct(r).has(e),l=ct(s).has(e);if(o&&l)throw new Error("matching complex expressions not supported");switch(t){case"+":case"*":if(o)return yield*u(s),yield i[t],void(yield*u(r));if(l)return yield*u(r),yield i[t],void(yield*u(s));break;case"-":case"/":if(o)return yield*u(s),yield i[t],void(yield*u(r));if(l)return yield*u(r),yield t,void(yield*u(s));break;case"%":throw new Error("unimplemented modulo operator solving");default:pt(t,"invalid expression operator")}break;case"symbol":return void(n.name!==e&&(yield n.name))}yield at(t,n)}}(n,e,o,s);r===o?yield`const ${e} = ${r};`:(yield`const ${e} = (${h} + ${r}) % ${h};`,yield`if (Math.floor(${e}) !== ${e}) continue;`),yield*d()})));break;case"number":n.define(o),yield`const ${o} = ${s.value};`,yield*d();break;default:throw new Error(`unsupported match type ${s.type}`)}}else{const t=[],r=()=>{for(;t.length>1;){const e=t.pop(),n=t.pop();t.push(`${n}\n| ${e}`)}return t.pop()||""};for(const{name:e,then:s,max:o,shift:a}of l){const{mode:l}=s;if("_"!==l){const{value:r}=s,a=i(r,{head:`then ${e} ${l}${"="==l?"":"="} `}),u=at(n,r,ot.length);"0"!==u?t.push(`${u} & ${o} ${[...a].join("\n")}`):yield*a}t.length&&a&&t.push(`( ${r()}\n) << ${a}`)}n.has("_priorMask")&&t.unshift(`_rules[${e}] & _priorMask`),t.length&&(yield*dt({head:`_rules[${e}] = `,cont:"  "},r().split(/\n/)),yield"  ;")}}yield*u(0)}}(t),n=l(o((()=>s([...ft(e)].join("")))),(t=>{try{return s(Function(`"use strict"; return (${t})`))}catch(e){return i(new Error(`${e}\nTrying to compile:\n${t}`))}})),r=l(n,(t=>o((()=>s(t())))));return l(r,(t=>"function"!=typeof t?i(new Error(`invalid builder function, got a ${typeof t} instead of a function`)):s(t)))}function at(t,e,n=0){switch(e.type){case"turn":return`0x${e.names.reduce(((t,e)=>t|S[e]),0).toString(16).padStart(2,"0")}`;case"turns":const r=[];for(const{count:t,turn:n}of e.turns){const e=`0x${S[n].toString(16).padStart(2,"0")}`;for(let n=0;n<t.value;n++)r.push(e)}return`[${r.join(", ")}]`;case"expr":const s=ot.indexOf(e.op),i=at(t,e.arg1,s),o=at(t,e.arg2,s),l=`${i} ${e.op} ${o}`;return s<n?`(${l})`:l;case"member":const a=at(t,e.value,0);return`${a}[${at(t,e.item,ot.length)} % ${a}.length]`;case"symbol":case"identifier":if(!t.has(e.name))throw new Error(`undefined ${e.type} ${JSON.stringify(e.name)}`);return e.name;case"number":return 16===e.base?`0x${e.value.toString(16)}`:e.value.toString(10);default:return pt(e,"invalid value node"),"/* invalid node type */"}}function*ut(t,e){for(const n of ct(t))e.has(n)||(yield n)}function ct(t){const e=new Set;return st(t,nt("symbol",(({name:t})=>{e.add(t)}))),e}function*ht(t,e="// "){yield*function*(t,e){const n=0==t.trim().length;for(const r of e)yield r||!n?t+r:r}(e,t)}function*ft(t,e="\n"){for(const n of t)yield n+e}function*dt(t,...e){"string"==typeof t&&(t={head:t});const{head:n="",foot:r="",cont:s="",zero:i="undefined"}=t;let o="",l=!1;for(const t of mt(...e))l?(yield o,o=`${s}${t}`):(l=!0,o=`${n}${t}`);l?yield`${o}${r}`:yield`${n}${i}${r}`}function*mt(...t){for(const e of t)"string"==typeof e?yield e:yield*e}function pt(t,e){throw new Error(`${e}: ${JSON.stringify(t)}`)}function*yt(t){const{value:e}=G(t);if(e)for(const{then:t,...n}of function*(t){t.entries.some((({type:t})=>"ant"==t))&&t.entries.every((({type:t})=>"rule"!=t))&&(yield{name:"liftToTurmite",label:"Convert To Turmite",then:t=>rt(t,nt("ant",(({turns:t})=>et(t))))||t})}(e))yield{...n,then(e){const{value:n}=G(e);if(!n)return e;return[...K(t(n))].join("\n")}}}function*gt(t){/^\s*ant(\(.*|\s*$)/.test(t)?yield*vt.ant():yield*vt.turmite()}const vt={*ant(){yield"# Basic Ant Rule Format",yield"",yield"    ant(<number>?<turn>...)",yield"",yield"Each <turn> may be one of:",yield"  - L=left, R=right",yield"  - B=back, F=forward",yield"  - P=port, S=starboard (these are rear-facing left/right)",yield"",yield"## Examples",yield"",yield"    ant( R L )",yield"    ant( 2L 13R 2L )",yield"    ant( 2L 13R 2L 42F )"},*turmite(){yield"# Turmite Rule Format",yield"",yield"The basic turmite rule form is:",yield"    <when> => <then>",yield"",yield"Where <when> has the form:",yield"    <state>, <color>",yield"The state> and <color> are simple numeric (uint8) expressions that match against the world tile color (uint8) and internal turmite state (uint8).",yield"For example, a <color> term of 2*c only matches even colors",yield"",yield"Similarly <then> has the form:",yield"    <state>, <color>, <turn>",yield"",yield"- <turn> may be one of L, R, F, B, P, or S as to an ant(...) rule",yield"  - additonal absolute directions are supported: NW, NO, NE, SE, SO, and SW",yield"- <turn> may also be an indexed turns(...)[INDEX] expression",yield"- right hand side expressions may reference symbols matched on the left",yield"  - e.g. the basic ant(...) construction translates to 0, c => 0, c + 1 turns(...)[c]",yield"- finally, variable assignments may precede rules, to define things like a turn sequence for use in multiple places",yield"",yield"## Examples",yield"",yield"To make a bi-modal ant that switches between LR / RL rules on every 16-th color:",yield"    0, c => 0, c + 1, turns(L R)[c]",yield"    1, c => 1, c + 1, turns(R L)[c]",yield"    0, 16 * c - 1 => 1, _, _",yield"    1, 16 * c - 1 => 0, _, _"}};class bt{static TestSpec={MaxColor:255,MaxState:255,MaxTurn:65535,MaskResultState:4278190080,MaskResultColor:16711680,MaskResultTurn:65535,ColorShift:8,TurnShift:16,ColorByteWidth:1,StateByteWidth:1,TurnByteWidth:2,ResultByteWidth:4,ResultStateShift:24,ResultColorShift:16,ResultTurnShift:0,KeyByteWidth:2,KeyStateMask:65280,KeyColorMask:255,KeyColorShift:0,KeyStateShift:8};static from(t,e=bt.TestSpec,n=new bt){if("string"==typeof t){const{value:e,err:n}=l(G(t),(t=>lt(t)));if(n)return i(n);t=e}n.reset(),n.rules.fill(0);const{value:r,err:o}=t(n.rules,e);if(o)return i(o);const{numColors:a,numStates:u,specString:c}=r;return n.numColors=a,n.numStates=u,n.specString=c,s(n)}constructor(){this.numStates=0,this.numColors=0,this.specString="<null turmite>",this.rules=new Uint32Array(65536),this.dir=0,this.pos=new T(0,0),this.state=0,this.index=0}reset(){this.dir=0,this.pos.scale(0),this.state=0}toString(){return this.specString||"<UNKNOWN turmite>"}step(t){const{rules:e,index:n}=this;t.updateEnt(n,((t,n,r)=>{const s=65280&r,i=e[n<<8|255&r];n=(4278190080&i)>>24,r=s|(16711680&i)>>16|256;const o=[...E(65535&i,t)];switch(o.length){case 0:break;case 1:t=o[0];break;default:throw new Error("turmite forking unimplemented")}return{dir:t,state:n,datum:r}}))}}var wt="undefined"!=typeof Float32Array?Float32Array:Array;Math.hypot||(Math.hypot=function(){for(var t=0,e=arguments.length;e--;)t+=arguments[e]*arguments[e];return Math.sqrt(t)});var $t=function(t,e,n,r,s,i,o){var l=1/(e-n),a=1/(r-s),u=1/(i-o);return t[0]=-2*l,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=-2*a,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=2*u,t[11]=0,t[12]=(e+n)*l,t[13]=(s+r)*a,t[14]=(o+i)*u,t[15]=1,t};function Tt(){var t=new wt(3);return wt!=Float32Array&&(t[0]=0,t[1]=0,t[2]=0),t}function xt(t,e,n){var r=new wt(3);return r[0]=t,r[1]=e,r[2]=n,r}function St(){var t=new wt(4);return wt!=Float32Array&&(t[0]=0,t[1]=0,t[2]=0),t[3]=1,t}Tt(),function(){var t,e=(t=new wt(4),wt!=Float32Array&&(t[0]=0,t[1]=0,t[2]=0,t[3]=0),t)}();var Et;Tt(),xt(1,0,0),xt(0,1,0),St(),St(),Et=new wt(9),wt!=Float32Array&&(Et[1]=0,Et[2]=0,Et[3]=0,Et[5]=0,Et[6]=0,Et[7]=0),Et[0]=1,Et[4]=1,Et[8]=1,function(){var t=function(){var t=new wt(2);return wt!=Float32Array&&(t[0]=0,t[1]=0),t}()}();class Rt{constructor(t,e,n,r){const s={},i={};for(const r of n){const n=t.getUniformLocation(e,r);if(!n)throw new Error(`unable to find uniform ${r}`);s[r]=n}for(const n of r){const r=t.getAttribLocation(e,n);if(r<0)throw new Error(`unable to find attrib ${n}`);i[n]=r}this.gl=t,this.prog=e,this.uniform=s,this.attr=i}use(){const{gl:t,prog:e}=this;t.useProgram(e)}enable(){const{gl:t,attr:e}=this;this.use();for(const n of Object.values(e))t.enableVertexAttribArray(n)}disable(){const{gl:t,attr:e}=this;for(const n of Object.values(e))t.disableVertexAttribArray(n)}}class Ht{constructor(t,{unit:e,format:n="rgb",colors:r}){const s=function(){if("srgb"==n){const e=t.getExtension("EXT_sRGB");if(e)return e.SRGB_EXT;console.warn("sRGB Gl extension not available, falling back to RGB colorspace")}return t.RGB}(),i=new Uint8Array(768),o=t.createTexture();this.gl=t,this.unit=e,this.format=s,this.data=i,this.tex=o,t.activeTexture(t.TEXTURE0+e),t.bindTexture(t.TEXTURE_2D,o),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),r&&this.setColorsRGB(r)}use(t){const{gl:e,unit:n}=this;e.activeTexture(e.TEXTURE0+n),e.uniform1i(t,n)}setColorsRGB(t=[]){const{gl:e,unit:n,tex:r,format:s,data:i}=this;i.fill(0),function(t,e){const n=t?.length;if(!n)return;let r=0;for(const s of e)if(t[r]=s,++r>=n)return}(i,function*(){for(const[e,n,r]of t)yield Math.round(255*e),yield Math.round(255*n),yield Math.round(255*r)}()),e.activeTexture(e.TEXTURE0+n),e.bindTexture(e.TEXTURE_2D,r),e.texImage2D(e.TEXTURE_2D,0,s,256,1,0,s,e.UNSIGNED_BYTE,i)}}class kt{constructor(t,e,n,r){this.id=t,this.index=[],this.tileRanges=new Map,this.usedElements=0,this.elements=e,this.verts=n,this.colors=r}get capacity(){return Math.min(this.verts.capacity,this.colors.capacity)}reset(){this.index.length=0,this.tileRanges.clear(),this.usedElements=0}addElement(t){this.elements.data[this.usedElements++]=t}flush(){this.verts.flush(),this.colors.flush(),this.shipElements()}shipElements(){this.elements.ship(0,this.usedElements)}addTile(t,e){const{index:n,tileRanges:r,capacity:s}=this,[i,o]=function(t,e,n){let r=-1,s=-1,i=-1,o=0,l=-1,a=-1,u=0;for(let e=0;e<t.length;e+=2){const c=t[e],h=t[e+1];if(c)0!==u&&(l=-1,a=-1,u=0);else if(0===u&&(l=e,a=o),u+=h,n<=u){const t=u-n;(i<0||t<i)&&(r=l,s=a,i=t)}o+=h}const c=e-o;if(n<=c){const e=c-n;(i<0||e<i)&&(r=t.length,s=o,i=e)}return[r,s,i]}(n,s,e);return i<0?-1:(i<n.length?(!function(t,e,n){if(t[e])throw new Error("not a tombstone");let r=t[e+1];t[e+1]=n;let s,i=e+2,o=0;for(;r<n;i+=2)r+=t[i+1],o+=2;if(o>0){for(s=e+2;i<t.length;)t[s++]=t[i++];i=e+2}if(n<r){const e=r-n;if(t[i]){let n=t.length-i;for(o>=2?o-=2:t.push(0,0),s=t.length-1;n-- >0;s--)t[s]=t[s-2];t[i]=0,t[i+1]=e}else t[i+1]+=e}t.length-=o}(n,i,e),n[i]=t):n.push(t,e),r.set(t,[o,o+e]),o)}removeTile(t){const{index:e,tileRanges:n}=this;n.delete(t);for(let n=0;n<e.length;n+=2)if(e[n]===t){for(e[n]=0;0===e[e.length-2];)e.length-=2;break}}tileOffset(t){const e=this.tileRanges.get(t);return e?e[0]:-1}}class _t{constructor(t,e,n,r){this.gl=t,this.target=e,this.width=n,this.data=r,this.buf=this.gl.createBuffer(),this.gl.bindBuffer(this.target,this.buf),this.gl.bufferData(this.target,this.data,t.STATIC_DRAW)}get capacity(){return this.data.length/this.width}ship(t,e){const{gl:n,target:r,buf:s,data:i,width:o}=this,l=t*o,a=e*o;n.bindBuffer(r,s),n.bufferSubData(r,l*i.BYTES_PER_ELEMENT,i.subarray(l,a))}}class Mt extends _t{constructor(t,e,n,r){super(t,e,n,r),this.inval=[]}invalidate(t,e){!function(t,e,n){if(n<e)throw new Error("invalid range");if(n===e)return;let r=!1,s=0;for(;s<t.length;s+=2){if(e<=t[s]-1){t[s]=e,r=!0;break}if(e<=t[s+1]+1){r=!0;break}}if(!r)return void t.push(e,n);let i=s;for(r=!1;i<t.length;i+=2){if(n<t[i]-1){if(i===s)throw new Error("degenerate range detected");r=!0;break}if(n<=t[i+1]+1){if(i===s)return;n=t[i+1]+(n===t[i+1]+1?1:0),i+=2,r=!0;break}}if(!r)return t[s+1]=n,void(t.length=s+2);if(t[s+1]=n,s+=2,s!=i){for(;i<t.length;)t[s++]=t[i++],t[s++]=t[i++];t.length=s}}(this.inval,t,e)}flush(){const{gl:t,inval:e,target:n,buf:r,data:s,width:i}=this;if(e.length){t.bindBuffer(n,r);for(const{begin:r,end:o}of function*(t){for(let e=0;e<t.length;){const n=t[e++],r=t[e++];yield{begin:n,end:r}}}(e)){const e=r*i,l=o*i;t.bufferSubData(n,s.BYTES_PER_ELEMENT*e,s.subarray(e,l))}e.length=0}}}const Ct=[];class At{static NextId=1;static alloc(){if(Ct.length>0){const t=Ct.shift();if(void 0!==t)return t}return new At}static free(t){Ct.push(t)}free(){At.free(this)}constructor(){this.id=At.NextId++,this.origin=new T,this.oqo=new T,this.width=0,this.height=0,this.data=null,this.dirty=!1}init(t,e,n){const r=e*n,s=r*Uint16Array.BYTES_PER_ELEMENT;return t.toOddQOffsetInto(this.origin),this.width=e,this.height=n,null===this.data||this.data.buffer.byteLength<s?this.data=new Uint16Array(r):(this.data.length!==r&&(this.data=new Uint16Array(this.data.buffer,0,r)),this.data.fill(0)),this.dirty=!1,this}boundingBox(){const{origin:t,width:e,height:n}=this;return new x(t,t.copy().addTo(e,n))}centerPoint(){const{origin:t,width:e,height:n}=this;return new T(t.q+Math.floor(e/2),t.r+Math.floor(n/2))}pointToIndex(t){const{oqo:e,origin:n,width:r}=this;return t.toOddQOffsetInto(e),(e.r-n.r)*r+(e.q-n.q)}update(t,e){const{data:n}=this;if(!n)return NaN;const r=this.pointToIndex(t),s=e(Lt(n[r]),t);return n[r]=s,s}get(t){const{data:e}=this;return e?Lt(e[this.pointToIndex(t)]):NaN}set(t,e){const{data:n}=this;return n&&(n[this.pointToIndex(t)]=e),e}eachTile(t){t(this)}eachDataPoint(t){const{oqo:e,origin:{q:n,r:r},width:s,height:i,data:o}=this;if(o){const l=n+s,a=r+i;let u=0;for(e.r=r;e.r<a;e.r++)for(e.q=n;e.q<l;e.q++,u++)t(e,Lt(o[u]))}}expandBoxTo(t,e){const{origin:{q:n,r:r},width:s,height:i}=this,o=n+s,l=r+i;isNaN(t.q)||isNaN(t.r)||isNaN(e.q)||isNaN(e.r)?(t.q=n,t.r=r,e.q=o,e.r=l):(n<t.q&&(t.q=n),r<t.r&&(t.r=r),o>e.q&&(e.q=o),l>e.r&&(e.r=l))}expandBoxToIf(t,e,n){const{data:r,width:s,origin:{q:i}}=this;let{origin:{q:o,r:l}}=this,a=0;if(r){if(isNaN(t.q)||isNaN(t.r)||isNaN(e.q)||isNaN(e.r))for(;a<r.length;){if(Lt(r[a])&n){t.q=o,e.q=o,t.r=l,e.r=l;break}a++,o++,o>=i+s&&(o=i,l++)}for(;a<r.length;)Lt(r[a])&n&&(o<t.q?t.q=o:o>=e.q&&(e.q=o),l<t.r?t.r=l:l>=e.r&&(e.r=l)),a++,o++,o>=i+s&&(o=i,l++)}}*dump(){const{origin:t,data:e,width:n}=this;if(yield"Tile @"+t.toString(),e){const t=[];for(let r=0;r<e.length;r++)r&&r%n==0&&(yield t.join(" "),t.splice(0)),t.push(Lt(e[r]).toString());yield t.join(" ")}}}function Lt(t){return void 0===t?NaN:t}class Bt{constructor(){this.minTileArea=4,this.maxTileArea=64,this.oqo=new T(0,0),this.root=null,this.tiles=new Map,this.dirtyTiles=[],this.tileRemoved=zt,this.tileAdded=zt}getTile(t){return this.tiles.get(t)||null}addTile(t){this.tiles.set(t.id,t),t.dirty=!0,this.dirtyTiles.push(t),this.tileAdded(t)}removeTiles(...t){const{dirtyTiles:e}=this;if(t.some((t=>t.dirty))){const n=new Set(t.map((({id:t})=>t)));let r=0;for(let t=0;t<e.length;++t){const s=e[t];if(s){const{id:i}=s;n.has(i)||(r!=t&&(e[r]=s),++r)}}e.length=r}for(const e of t)this.tileRemoved(e);for(const{id:e}of t)this.tiles.delete(e);for(const e of t)e.free()}reset(){this.dirtyTiles.length=0,this.tiles.clear(),this.root=null}dump(){const{root:t}=this;return t?[...t.dump()].join("\n"):""}boundingBox(){const{root:t}=this;return t?t.boundingBox():null}eachTile(t){const{root:e}=this;null!==e&&e.eachTile(t)}eachDataPoint(t){const{root:e}=this;null!==e&&e.eachDataPoint(t,null)}centerPoint(){const{root:t}=this;return t?t.centerPoint():null}_ensureRoot(){let{root:t}=this;if(!t){const e=2*Math.ceil(Math.sqrt(this.minTileArea));t=It.alloc?It.alloc():new It,t.init(this,null,e)}return t}_ensureTile(t){const{oqo:e}=this;let n=this._ensureRoot();for(t.toOddQOffsetInto(e);!n.box.contains(e);){const t=n.expand();if(!t)return null;n=t}return n!==this.root&&(this.root=n),n.oqo.copyFrom(e),n._getOrCreateTile()}update(t,e){const{oqo:n,dirtyTiles:r}=this,s=this._ensureTile(t);return s?(s instanceof At&&!s.dirty&&(s.dirty=!0,r.push(s)),s.update(n,e)):NaN}get(t){return this._ensureRoot().get(t)}set(t,e){const{oqo:n,dirtyTiles:r}=this,s=this._ensureTile(t);return s?(s instanceof At&&!s.dirty&&(s.dirty=!0,r.push(s)),s.set(n,e)):NaN}}const Nt=[3,2,1,0],qt=[new T(0,0),new T(1,0),new T(0,1),new T(1,1)],Pt=[new T(-1,-1),new T(1,-1),new T(-1,1),new T(1,1)];function Ft(t,e,n){if(!e)return null;const r=e instanceof At?qt[n]:Pt[n],s=Nt[n];if(null==r||null==s)return null;const i=e instanceof At?e.width:e.tileSize,o=e.oqo.copyFrom(r).scale(i).add(e.origin),l=2*(e instanceof At?e.width:e.size),a=It.alloc?It.alloc():new It;return a.init(t,o,l),a._setTile(s,e),a}const Ot=[];class It{static alloc(){if(Ot.length>0){const t=Ot.shift();if(void 0!==t)return t}return new It}static free(t){t.reset(),Ot.push(t)}free(){It.free(this)}constructor(){this.tree=null,this.origin=new T(0,0),this.oqo=new T(0,0),this.box=new x,this.size=0,this.tileSize=0,this.concrete=0,this.tiles=[null,null,null,null],this._replaceme=null}init(t,e,n,r){return this.tree=t,this.concrete=0,this._replaceme=r||null,null!==e?e.toOddQOffsetInto(this.origin):this.origin.q=this.origin.r=0,this._setSize(n),this}reset(){const{tiles:t}=this,[e,n,r,s]=t;e&&(e.free(),t[0]=null),n&&(n.free(),t[1]=null),r&&(r.free(),t[2]=null),s&&(s.free(),t[3]=null)}_setSize(t){const{origin:{q:e,r:n},box:{topLeft:r,bottomRight:s}}=this,i=Math.floor(t/2);this.size=t,this.tileSize=i,r.q=e-i,r.r=n-i,s.q=e+i,s.r=n+i}*dump(){const{origin:t,box:e,tiles:n}=this;yield`TreeNode @${t}`,yield`  box: ${e}`;for(let t=0;t<n.length;t++){const e=n[t],[r,...s]=e?[...e.dump()]:["null"];yield`[${t}]: ${r}`;for(const t of s)yield`     ${t}`}}eachTile(t){const e=this._mayCompact();if(e)return void e.eachTile(t);const{tiles:[n,r,s,i]}=this;n&&n.eachTile(t),r&&r.eachTile(t),s&&s.eachTile(t),i&&i.eachTile(t)}expand(){const{tree:t,tiles:e}=this;if(!t)return null;this._setSize(2*this.size);for(let n=0;n<e.length;n++){const r=Ft(t,e[n],n);r&&this._setTile(n,r)}return this}boundingBox(){return this.box}eachDataPoint(t,e=null){const n=this._mayCompact();if(n)return void n.eachDataPoint(t);const{tileSize:r,origin:{q:s,r:i},oqo:o,tiles:[l,a,u,c]}=this;function h(n){if("number"!=typeof e)return;const l=s+(1&n?0:-r),a=i+(n>>1?0:-r),u=l+r,c=a+r;for(o.q=l,o.r=a,o.r=a;o.r<c;o.r++)for(o.q=l;o.q<u;o.q++)t(o,e)}l?l.eachDataPoint(t,e):h(0),a?a.eachDataPoint(t,e):h(1),u?u.eachDataPoint(t,e):h(2),c?c.eachDataPoint(t,e):h(3)}_mayCompact(){if(!this.tree||!this._replaceme)return null;if(4!=this.concrete)return null;const t=this.compact();if(null===t)return this.concrete=5,null;const e=[];for(const t of this.tiles)t&&t instanceof At&&e.push(t);return this._replaceme(t),this.tree.removeTiles(...e),this.tree.addTile(t),t}compact(){if(!this.tree)return null;const{size:t,tree:{maxTileArea:e}}=this;if(t*t>e)return null;const{box:{topLeft:n},tiles:r}=this,s=At.alloc?At.alloc():new At;s.init(n,t,t);for(const t of r)t&&t.eachDataPoint(((t,e)=>s.set(t,e)),null);return s}centerPoint(){return this.origin}update(t,e){const{oqo:n,box:r,tree:s}=this;if(!s)return NaN;const{dirtyTiles:i}=s;if(t.toOddQOffsetInto(n),!r.contains(n))throw new Error("update out of bounds");const o=this._mayCompact()||this._getOrCreateTile();return o?(o instanceof At&&!o.dirty&&(o.dirty=!0,i.push(o)),o.update(n,e)):NaN}get(t){const{oqo:e,box:n}=this;if(t.toOddQOffsetInto(e),!n.contains(e))return NaN;const r=this._getTile();return r?r.get(e):0}set(t,e){const{oqo:n,box:r,tree:s}=this;if(!s)return NaN;const{dirtyTiles:i}=s;if(t.toOddQOffsetInto(n),!r.contains(n))throw new Error("set out of bounds");const o=this._mayCompact()||this._getOrCreateTile();return o?(o instanceof At&&!o.dirty&&(o.dirty=!0,i.push(o)),o.set(this.oqo,e)):NaN}_index(){const{oqo:{q:t,r:e},origin:{q:n,r:r}}=this;return 2*(e<r?0:1)+(t<n?0:1)}_getTile(){const t=this._index();return this.tiles[t]}_getOrCreateTile(){const{tree:t,tiles:e,tileSize:n}=this;if(!t)return null;const r=this._index(),s=e[r];return s||(n*n<=t.minTileArea?this._allocTile(r):this._allocNode(r))}_allocTile(t){const{tree:e,oqo:{q:n,r:r},tileSize:s}=this;if(!e)return null;const i=this.origin.copy();n<i.q&&(i.q-=s),r<i.r&&(i.r-=s);const o=At.alloc?At.alloc():new At;return o.init(i,s,s),this._setTile(t,o),e.addTile(o),o}_allocNode(t){const{tree:e,oqo:{q:n,r:r},tileSize:s}=this;if(!e)return null;const i=this.origin.copy();i.q+=s/(n<i.q?-2:2),i.r+=s/(r<i.r?-2:2);const o=It.alloc?It.alloc():new It;return o.init(e,i,s),this._setTile(t,o),o}_setTile(t,e){const n=this.tiles[t];n&&n instanceof It&&(n._replaceme=null),this.tiles[t]=e,e instanceof At?this.concrete++:e instanceof It&&(e._replaceme=e=>this._setTile(t,e))}}function zt(){}class Wt{static MaxColor=255;static MaxState=255;static MaxTurn=65535;static MaskResultState=4278190080;static MaskResultColor=16711680;static MaskResultTurn=65535;static ColorShift=8;static TurnShift=16;static FlagVisited=256;static MaskColor=255;static MaskFlags=65280;constructor(){this.numColors=0,this.numStates=0,this.stepCount=0,this.tile=new Bt,this.ents=[],this.views=[],this.redrawTiming=[],this.now=()=>performance.now(),this.tmpCP=new $}getEntPos(t){const e=this.ents[t];return e?e.pos:new T(NaN,NaN)}getEntDir(t){const e=this.ents[t];return e?e.dir:NaN}reset(){const{ents:t,tile:e,views:n}=this;for(const e of t)e.reset();e.reset(),this.stepCount=0;for(const t of n)t.reset();const r=t.map((({pos:t})=>t));for(const t of r)e.update(t,(t=>Wt.FlagVisited|t))}updateEnt(t,e){const{ents:n,tile:r,tmpCP:s}=this,i=n[t];if(!i)return;const{pos:o,dir:l,state:a}=i;r.update(o,(t=>{const{dir:n,state:r,datum:u}=e(l,a,t),c=$.basis[n];return c&&o.toCubeInto(s).add(c).toOddQOffsetInto(o),i.dir=n,i.state=r,u})),r.update(i.pos,(t=>Wt.FlagVisited|t))}step(){this._step(),this.redraw()}stepn(t){for(let e=0;e<t;e++)this._step();return this.stepCount+=t,this.redraw()}_step(){for(const t of this.ents)t.step(this);for(const t of this.views)t.step();this.stepCount++}redraw(){let t=!1;const e=this.now();for(const e of this.views)e.needsRedraw&&(e.redraw(),t=!0);const n=this.now();if(t){const{redrawTiming:t}=this;for(;void 0!==t[0]&&e-t[0]>5e3;)t.shift(),t.shift();t.push(e,n)}return t}redrawTimingStats(){const{redrawTiming:t}=this;if(t.length<4)return null;let e=0,n=0,r=0,s=0;for(;s<t.length;){const i=t[s++]||NaN,o=(t[s++]||NaN)-i-n;e++,n+=o/e,r+=o*o}return r/=e-1,{n:e,m1:n,m2:r}}removeEnt(t){const{index:e}=t,{ents:n,views:r}=this;if(n[e]!==t)throw new Error("removeEnt mismatch");let s=e;for(let t=s++;t<n.length;t++){const e=n[t];e&&(n[s]=e,e.index=s,s++)}n.length=s;for(let t of r)t.removeEnt(s)}setEnts(t){const{ents:e,tile:n,views:r}=this,s=e.length;e.length=0;for(const n of t)n.index=e.length,e.push(n);const i=t.map((({pos:t})=>t));for(const t of i)n.update(t,(t=>Wt.FlagVisited|t));this.numColors=Math.max.apply(null,e.map((({numColors:t})=>t))),this.numStates=Math.max.apply(null,e.map((({numStates:t})=>t)));let o=0;for(;o<s;++o)for(const t of r)t.updateEnt(o);for(;o<t.length;++o)for(const t of r)t.addEnt(o);for(;o<s;++o)for(const t of r)t.removeEnt(o)}addView(t){return this.views.push(t),t.updateEnts(),t}}class Dt{constructor(t,e,n,r){this.name=t,this.type=e,this.source=n,this.nextShader=r}linkWith(t){const{name:e,type:n,source:r,nextShader:s}=this;return s&&(t=s.linkWith(t)),new Dt(e,n,r,t)}compile(t){const{name:e,type:n,source:r}=this,o=function(t,e){switch(e){case"frag":return s(t.FRAGMENT_SHADER);case"vert":return s(t.VERTEX_SHADER);default:return i(new Error("invalid glsl shader type "+JSON.stringify(e)))}}(t,n);if(o.err)return o;const l=t.createShader(o.value);if(!l)return i(new Error(`unable to create ${n} shader`));if(t.shaderSource(l,r),t.compileShader(l),!t.getShaderParameter(l,t.COMPILE_STATUS)){const s=function(t,e){var n=/^ERROR: \d+:(\d+):/.exec(e);if(!n)return e;const r=parseInt(n[1]||""),s=3,i=t.split(/\n/),o=i.length.toString().length;return[...jt(Ut(o,i),r,s,`${" ".repeat(o)} ^-- ${e}`)].join("\n")}(r,t.getShaderInfoLog(l)||"");return i(new Error(`${e} ${n} shader compile error: ${s}`))}return s(l)}load(t){const e=t.createProgram();if(!e)return i(new Error("unable to create gl program"));for(let n=this;n;n=n.nextShader){const r=n.compile(t);if(r.err)return r;t.attachShader(e,r.value)}if(t.linkProgram(e),!t.getProgramParameter(e,t.LINK_STATUS)){const n=t.getProgramInfoLog(e);return i(new Error(`shader program link error: ${n}`))}return s(e)}}function*Ut(t,e){let n=0;for(const r of e)n++,yield`${n.toString().padStart(t)}: ${r}`}function*jt(t,e,n,r){let s=0;for(const i of t)s++,Math.abs(e-s)<=n&&(yield i),s===e&&(yield r)}var Vt=new Dt("oddq_point","vert","uniform mat4 uPMatrix;uniform vec2 uVP;uniform float uRadius;attribute vec2 vert;attribute vec2 ang;attribute lowp float color;const vec2 a=vec2(1.5,sqrt(3.0));varying lowp float vertColor;varying mediump vec2 varAng;void main(void){gl_PointSize=uVP.y*abs(uPMatrix[1][1])*uRadius;gl_Position=uPMatrix*vec4(vec2(vert.x,vert.y+mod(vert.x,2.0)/2.0)*a,0.0,1.0);vertColor=color+1.0/512.0;varAng=ang;}"),Gt=new Dt("hex","frag","varying lowp float vertColor;varying mediump vec2 varAng;const mediump float a=3.141592653589793;const mediump float b=2.0*a;const mediump vec2 c=vec2(0.5,0.5);const mediump vec2 d=vec2(1.0,0.0)/2.0;const mediump vec2 e=vec2(0.5,sqrt(3.0)/2.0)/2.0;const mediump float f=(e.y-d.y)/(e.x-d.x);const mediump float g=e.y-f*e.x;uniform sampler2D uSampler;void main(void){mediump vec2 h=gl_PointCoord-c;if(varAng.x!=varAng.y){mediump float i=mod(atan(h.y,h.x),b);if(varAng.x<varAng.y){if(i<varAng.x||i>varAng.y){discard;}}else{if(i>=varAng.y&&i<=varAng.x){discard;}}}h=abs(h);if(h.y>e.y||h.y>f*h.x+g){discard;}gl_FragColor=texture2D(uSampler,vec2(vertColor,0));}");const Qt=2*Math.PI/6,Yt=2*Float32Array.BYTES_PER_ELEMENT;class Xt{constructor(t,e){if(this.world=t,this.$canvas=e,this.topLeftQ=new T,this.bottomRightQ=new T,this.maxElement=65535,this.gl=this.$canvas.getContext("webgl")||null,!this.gl)throw new Error("no webgl support");this.perspectiveMatrix=function(t){return t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=1,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=1,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t}(new Float32Array(16));const n=r(Vt.linkWith(Gt).load(this.gl));if(this.hexShader=new Rt(this.gl,n,["uPMatrix","uVP","uRadius"],["vert","ang","color"]),this.uSampler=this.gl.getUniformLocation(this.hexShader.prog,"uSampler"),!this.uSampler)throw new Error("missing uSampler uniform");this.tileWriter=new Jt(this.maxElement+1),this.tileBufferer=new Zt(this.gl,this.world,this.tileWriter),this.entBuffer=new Kt(this.gl),this.maxCellsPerTile=Math.floor((this.maxElement+1)/this.tileWriter.cellSize),this.cellPallete=new Ht(this.gl,{unit:0}),this.bodyPallete=new Ht(this.gl,{unit:1}),this.headPallete=new Ht(this.gl,{unit:2}),this.antCellColorGen=null,this.emptyCellColorGen=null,this.bodyColorGen=null,this.headColorGen=null,this.needsRedraw=!1,this.gl.clearColor(0,0,0,0),this.hexShader.use(),this.gl.uniform1f(this.hexShader.uniform.uRadius,1),this.updateSize()}reset(){const{tileBufferer:t,topLeftQ:e,bottomRightQ:n,world:{tile:r}}=this;t.reset(),e.q=0,e.r=0,n.q=0,n.r=0,r.eachTile(t.drawUnvisited?t=>t.expandBoxTo(e,n):t=>t.expandBoxToIf(e,n,Wt.FlagVisited)),this.updateSize()}expandTo(t){const{topLeftQ:e,bottomRightQ:n}=this,{q:r,r:s}=t.toOddQOffset();let i=!1;return r<e.q?(e.q=r,i=!0):r>=n.q&&(n.q=r,i=!0),s<e.r?(e.r=s,i=!0):s>=n.r&&(n.r=s,i=!0),i}updateSize(){const{gl:t,hexShader:{uniform:{uVP:e,uPMatrix:n}},perspectiveMatrix:r,$canvas:{width:s,height:i},tileWriter:{cellHalfWidth:o,cellHalfHeight:l},topLeftQ:a,bottomRightQ:u}=this;t.viewport(0,0,s,i),t.uniform2f(e,s,i);let{x:c,y:h}=a.toScreen(),{x:f,y:d}=u.toScreen();c-=o,h-=l,f+=o,d+=l;const m=u.q-a.q>0;1&a.q&&(h-=l),(1&u.q||m)&&(d+=l);const p=t.drawingBufferWidth/t.drawingBufferHeight,y=f-c,g=d-h,v=y/g;if(v<p){const t=g*p/2-y/2;c-=t,f+=t}else if(v>p){const t=y/p/2-g/2;h-=t,d+=t}$t(r,c,f,d,h,-1,1),t.uniformMatrix4fv(n,!1,r)}setDrawTrace(t){this.drawTrace=t,this.updateColors()}resize(t,e){const{$canvas:n}=this;n.width=t,n.height=e,this.updateSize(),this.redraw()}redraw(){const{gl:t,hexShader:e}=this;t.clear(t.COLOR_BUFFER_BIT),e.enable(),this.drawTiles(),this.drawEntities(),e.disable(),t.finish(),this.needsRedraw=!1}drawTiles(){const{gl:t,hexShader:{attr:{ang:e,vert:n,color:r},uniform:{uRadius:s}},uSampler:i,cellPallete:o,tileBufferer:l}=this;l.flush(),t.uniform1f(s,1),t.disableVertexAttribArray(e),o.use(i);for(const{index:e,verts:s,colors:i,elements:o,usedElements:a}of l.tileBuffers)e.length&&(t.bindBuffer(t.ARRAY_BUFFER,s.buf),t.vertexAttribPointer(n,s.width,t.FLOAT,!1,0,0),t.bindBuffer(t.ARRAY_BUFFER,i.buf),t.vertexAttribPointer(r,i.width,t.UNSIGNED_BYTE,!0,0,0),t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,o.buf),t.drawElements(t.POINTS,a,t.UNSIGNED_SHORT,0))}drawEntities(){const{gl:t,hexShader:{attr:{ang:e,vert:n,color:r},uniform:{uRadius:s}},uSampler:i,bodyPallete:o,headPallete:l,entBuffer:a,world:{ents:u}}=this;if(!u.length)return;const c=u.map((({pos:t})=>t)),h=u.map((({dir:t})=>t));a.ensureLen(u.length),t.enableVertexAttribArray(e),ee(a.colors,function*(){for(let t=0;t<c.length;t++)yield t}()),ee(a.verts,function*(){for(const[{q:t,r:e},n]of function*(t,e){for(let n=0;n<t.length&&n<e.length;n++)yield[t[n],e[n]]}(c,h)){yield t,yield e;const r=n*Qt;yield r+Qt,yield r}}()),o.use(i),t.uniform1f(s,.5),t.bindBuffer(t.ARRAY_BUFFER,a.bodyVertsBuf),t.bufferData(t.ARRAY_BUFFER,a.verts,t.STATIC_DRAW),t.vertexAttribPointer(n,2,t.FLOAT,!1,Yt,0),t.vertexAttribPointer(e,2,t.FLOAT,!1,Yt,Yt),t.bindBuffer(t.ARRAY_BUFFER,a.bodyColorsBuf),t.bufferData(t.ARRAY_BUFFER,a.colors,t.STATIC_DRAW),t.vertexAttribPointer(r,1,t.UNSIGNED_BYTE,!0,0,0),t.drawArrays(t.POINTS,0,a.len),function(t,e,n,r){const s=t?.length;if(!s)return;let i=e;for(const o of r){if(t[i]=o,++i>=s)return;i%n==0&&(i+=e)}}(a.verts,2,4,function*(){for(const t of h){const e=t*Qt;yield e,yield e+Qt}}()),l.use(i),t.uniform1f(s,.75),t.bindBuffer(t.ARRAY_BUFFER,a.headVertsBuf),t.bufferData(t.ARRAY_BUFFER,a.verts,t.STATIC_DRAW),t.vertexAttribPointer(n,2,t.FLOAT,!1,Yt,0),t.vertexAttribPointer(e,2,t.FLOAT,!1,Yt,Yt),t.bindBuffer(t.ARRAY_BUFFER,a.headColorsBuf),t.bufferData(t.ARRAY_BUFFER,a.colors,t.STATIC_DRAW),t.vertexAttribPointer(r,1,t.UNSIGNED_BYTE,!0,0,0),t.drawArrays(t.POINTS,0,a.len)}addEnt(){this.updateColors()}updateEnt(){this.updateColors()}removeEnt(){this.updateColors()}updateEnts(){this.updateColors()}setColorGen(t){const{makeColorGen:e}=t;this.emptyCellColorGen=te(e(0),Wt.MaxColor),this.antCellColorGen=te(e(1),Wt.MaxColor),this.bodyColorGen=e(2),this.headColorGen=e(3),this.updateColors()}updateColors(){const{drawTrace:t,world:{ents:e,numColors:n},cellPallete:r,emptyCellColorGen:s,antCellColorGen:i,bodyPallete:o,bodyColorGen:l,headPallete:a,headColorGen:u}=this,c=t?s:i;c&&r.setColorsRGB(c(n)),l&&o.setColorsRGB(l(e.length)),u&&a.setColorsRGB(u(e.length))}get drawUnvisited(){return this.tileBufferer.drawUnvisited}set drawUnvisited(t){this.tileBufferer.drawUnvisited=t}step(){const{world:t}=this;let e=!1;for(let n=0;n<t.ents.length;n++)e=this.expandTo(t.getEntPos(n))||e;e&&this.updateSize(),this.needsRedraw=!0}}class Kt{constructor(t){this.gl=t,this.len=0,this.cap=0,this.verts=null,this.colors=null,this.bodyVertsBuf=null,this.bodyColorsBuf=null,this.headVertsBuf=null,this.headColorsBuf=null}free(){const{gl:t}=this;this.verts=null,this.colors=null,t.deleteBuffer(this.bodyVertsBuf),t.deleteBuffer(this.bodyColorsBuf),t.deleteBuffer(this.headVertsBuf),t.deleteBuffer(this.headColorsBuf)}alloc(t){this.cap=t,this.verts=new Float32Array(4*this.cap),this.colors=new Uint8Array(1*this.cap),this.bodyVertsBuf=this.gl.createBuffer(),this.bodyColorsBuf=this.gl.createBuffer(),this.headVertsBuf=this.gl.createBuffer(),this.headColorsBuf=this.gl.createBuffer()}ensureLen(t){t>this.cap&&(this.cap>0&&this.free(),this.alloc(t<1024?2*t:t+Math.floor(t/4))),this.len=t}}class Jt{constructor(t){if(this.bufferSize=t,this.vertSize=2,this.colorSize=1,this.cellSize=1,this.maxCells=Math.floor(this.bufferSize/this.cellSize),this.maxCells<1)throw new Error("can't fit any tiles in that bufferSize");this.elementsSize=this.cellSize*this.maxCells+2*(this.maxCells-1),this.colors=null,this.cellWidth=Math.cos(0)-Math.cos(Math.PI),this.cellHeight=Math.sin(2*Math.PI/6)-Math.sin(2*Math.PI*5/6),this.cellHalfWidth=this.cellWidth/2,this.cellHalfHeight=this.cellHeight/2}newTileBuffer(t,e){const{elementsSize:n,bufferSize:r,vertSize:s,colorSize:i}=this;return new kt(t,new _t(e,e.ELEMENT_ARRAY_BUFFER,1,new Uint16Array(n)),new Mt(e,e.ARRAY_BUFFER,s,new Float32Array(r*s)),new Mt(e,e.ARRAY_BUFFER,i,new Uint8Array(r*i)))}writeTileVerts({data:t,origin:e,width:n,height:r},{verts:s},i){if(!t)return;ee(s.data.subarray(i*this.vertSize),function*(){const{q:t,r:s}=e,i=t+n,o=s+r;for(let e=s;e<o;e++)for(let n=t;n<i;n++)yield n,yield e}());const o=i+n*r;return s.invalidate(i,o),o}writeTileColors({data:t},{colors:e},n){if(!t)return;ee(e.data.subarray(n*this.colorSize),function*(){for(const e of t)yield e&Wt.MaskColor}());const r=n+t.length;return e.invalidate(n,r),r}}class Zt{constructor(t,e,n){this.gl=t,this.world=e,this.tileWriter=n,this.drawUnvisited=!1,this.tileBuffers=[],this.bufferForTileId=new Map,this.dirtyTileBuffers=new Set,this.world.tile.tileRemoved=t=>this.onWorldTileRemoved(t)}reset(){const{bufferForTileId:t,dirtyTileBuffers:e,tileBuffers:n}=this;t.clear(),e.clear();for(const t of n)t.reset()}onWorldTileRemoved(t){const{bufferForTileId:e,tileBuffers:n}=this,r=e.get(t.id);if(void 0!==r){const s=n[r];if(!s)throw new Error("got tileRemoved for an unknown tile");s.removeTile(t.id),e.delete(t.id)}}flush(){const{world:{tile:{dirtyTiles:t}},dirtyTileBuffers:e,tileBuffers:n}=this;for(const e of t)this.flushTile(e);t.length=0;for(const t of e){const e=n[t];this.flushTileBuffer(e)}e.clear()}flushTile(t){const{dirtyTileBuffers:e,tileWriter:n}=this,{tileBuffer:r,offset:s}=this.bufferFor(t);n.writeTileVerts(t,r,s),n.writeTileColors(t,r,s),e.add(r.id),t.dirty=!1}bufferFor(t){if(!t.data)throw new Error("unallocated tile will not be assigned a buffer");const{gl:e,bufferForTileId:n,tileWriter:r,tileBuffers:s}=this,i=n.get(t.id);if(void 0!==i){const e=s[i],n=e.tileOffset(t.id);if(n<0)throw new Error("dissociated tileBuffer.tiles -> tile");return{tileBuffer:e,offset:n}}for(const e of s){const s=e.addTile(t.id,t.data.length*r.cellSize);if(s>=0)return n.set(t.id,e.id),{tileBuffer:e,offset:s}}const o=r.newTileBuffer(s.length,e);s.push(o);const l=o.addTile(t.id,t.data.length*r.cellSize);if(l<0)throw new Error("unable to add tile to new tileBuffer");return n.set(t.id,o.id),{tileBuffer:o,offset:l}}flushTileBuffer(t){const{world:e,drawUnvisited:n}=this;t.usedElements=0;for(const r of t.tileRanges.keys()){const s=e.tile.getTile(r);if(!s)throw new Error(`tile #${r} missing in buffer #${t.id}`);if(!s.data)throw new Error(`tile #${r} has no data for buffer #${t.id}`);let i=t.tileOffset(s.id);for(const e of s.data)(n||e&Wt.FlagVisited)&&t.addElement(i),i++}t.flush()}}function te(t,e){return function*(n){const r=[...t(n)];if(n=r.length){yield*r;for(let t=r.length;t<e;t++)yield r[t%r.length]}}}function ee(t,e){const n=t?.length;if(!n)return;let r=0;for(const s of e)if(t[r]=s,++r>=n)return}const ne=["","m","µ","n"],re=["K","M","G","T","E"];function se(t){if(t<1){let e=0;for(;e<ne.length&&t<1;)e++,t*=1e3;return t.toPrecision(3)+ne[e]}if(t<1e3)return t.toFixed(0);t/=1e3;let e=0;for(;e<re.length&&t>1e3;)e++,t/=1e3;return t.toPrecision(3)+re[e]}function ie(t=global.window){return new Promise((e=>t.requestAnimationFrame(e)))}function oe({metaKey:t,altKey:e,ctrlKey:n},r){return[...function*(){let s="";if(t&&(yield"M"),e&&(yield"A"),n&&(yield"C"),"key"in r)if(({key:s}=r)," "===s)yield"Space";else yield s;else yield`button${r.button}`}()].join("-")}function le(t,e,...n){console.group(`${e} error`),console.error(t);for(const[t,e]of n)console.log(t,JSON.stringify(e));console.groupEnd()}const ae=new class{constructor({$body:t,$view:e=c(t,"#view",HTMLCanvasElement),$fpsOverlay:n=c(t,"#fpsOverlay",HTMLElement),$step:i=c(t,"#step",HTMLElement),$fps:l=c(t,"#fps",HTMLElement),$sps:a=c(t,"#sps",HTMLElement),$redrawTiming:m=c(t,"#redrawTiming",HTMLElement)}){const p=t.ownerDocument.defaultView;if(!p)throw new Error("$body has no defaultView");function g(){let e=h(t,"#prompt",HTMLElement);return e&&t.removeChild(e),e=t.appendChild(t.ownerDocument.createElement("div")),e.id="prompt",e.classList.add("prompt"),e}this.$body=t,this.$fpsOverlay=n,this.$step=i,this.$fps=l,this.$sps=a,this.$redrawTiming=m,this.window=p,this.lastStepTime=null,this.goalStepRate=0,this.stepRate=0,this.locked=!1,this.paused=!0,this.showFPS=!1,this.animTimes=[],this.stepTimes=[],this.animTiming=new b(180),this.titleBase=this.window.document.title,this.world=new Wt,this.view=new Xt(this.world,e),this.world.addView(this.view),this.world.tile.maxTileArea=this.view.maxCellsPerTile;const{bind:v,load:w,...$}=f(p);var T;v("colors",{parse:u,defaultValue:r(u("light")),listener:t=>{this.view.setColorGen(t),this.view.redraw()}}),v("rule",{parse:t=>bt.from(t,Wt),defaultValue:r(bt.from("ant(L R)",Wt)),listener:t=>this.setEnts(t?[t]:[])}),v("showFPS",{defaultValue:!1,listener:t=>{this.showFPS=t,this.$fpsOverlay.style.display=this.showFPS?"":"none"}}),v("stepRate",{parse:(T=parseInt,function(...t){return o((()=>s(T.apply(this,t))))}),defaultValue:4,listener:t=>this.setStepRate(t)}),v("drawUnvisited",{defaultValue:!1,listener:t=>this.view.drawUnvisited=t}),v("drawTrace",{defaultValue:!1,listener:t=>{this.view.setDrawTrace(t),this.view.redraw()}}),w(),this.hash=$;const x=[{name:"help",desc:"show this help screen",keys:["?","h","button2"],loop:function*(){yield{title:"Actions"},yield{help:function*(){for(const{name:t,keys:[e],desc:n}of x)yield`${t} ( key: \`${e}\` )`,yield`: ${n}`,yield""}()}}},{name:"play",desc:"play / pause the simulation",keys:["Space","button0"],then:()=>{this.playpause()}},{name:"step",desc:"single step when paused, pause if playing",keys:[".","button1"],then:()=>this.stepit()},{name:"reset",keys:["*"],desc:"reset the simulation to initial state",then:()=>this.reboot()},{name:"rule",keys:["/"],desc:"edit the simulated ant ruleset",prompt:this.rulePrompt()},{name:"colorscheme",keys:["c"],desc:"edit the color scheme used for tiles and ants",prompt:this.colorPrompt()},{name:"speed up",desc:"double simulation speed",keys:["+"],then:()=>this.hash.set("stepRate",2*this.stepRate)},{name:"slow down",desc:"halve simulation speed",keys:["-"],then:()=>this.hash.set("stepRate",Math.max(1,Math.floor(this.stepRate/2)))},{name:"FPS",desc:"show/hide runtime statistic overlay",keys:["f"],then:()=>this.hash.set("showFPS",!this.showFPS)},{name:"unvisited cells",desc:"toggle whether all visible cells are drawn instead of just visted cells ones",keys:["u"],then:()=>this.hash.set("drawUnvisited",!this.view.drawUnvisited)},{name:"fullscreen",desc:"enter/exit fullscreen mode",keys:["Enter"],then(){const{ownerDocument:e}=t;e.fullscreenElement?e.exitFullscreen&&e.exitFullscreen():t.requestFullscreen()}}];this.keymap=new Map(x.flatMap((t=>{const e="then"in t?t.then:(t=>()=>d(g,t))("prompt"in t?t.prompt:y(t.loop));return t.keys.map((t=>[t,()=>e()]))}))),this.keymap.set("Escape",(()=>{let e=h(t,"#prompt",HTMLElement);e&&t.removeChild(e)})),this.window.addEventListener("keydown",this),this.window.addEventListener("keyup",this),this.window.addEventListener("mouseup",this);let S=!1,E=0;this.hash.get("fullauto")?(S=!0,E=86400):(S=this.hash.get("autoplay"),E=parseInt(this.hash.get("autorefresh"),10)),!isNaN(E)&&E&&this.window.setTimeout((()=>this.window.location.reload()),1e3*E),S&&this.play()}reboot(){this.pause(),this.setEnts([this.hash.get("rule")])}setEnts(t){const e=t.map((t=>`${t}`)).join(", ");this.world.setEnts(t),this.world.reset(),this.view.$canvas.width=this.view.$canvas.width,this.view.redraw(),this.window.document.title=this.titleBase+": "+e}handleEvent(t){const e=e=>{let n=this.keymap.get(`${e}`)||this.keymap.get(`${e.toLowerCase()}`)||this.keymap.get("");n&&(t.preventDefault(),n(e))},{type:n}=t;let r=h(this.$body,"#prompt",HTMLElement);const{target:s}=t;if(s===r||s===this.view.$canvas||s===this.window.document.documentElement||s===this.window.document.body)switch(n){case"mouseup":t instanceof MouseEvent&&e(oe(t,{button:t.button}));break;case"keydown":if(t instanceof KeyboardEvent&&"Escape"===t.key)t.preventDefault();break;case"keyup":t instanceof KeyboardEvent&&e(oe(t,{key:t.key}))}}rulePrompt(){const{hash:t}=this,e="rule";return y((function*(n){let r=t.getStr(e);for(const s of n)if("value"in s){({value:r}=s);const{res:{err:n},str:i}=t.set(e,r);if(!n)return!0;i&&(r=i),yield{error:n.message}}for(const{name:s,then:i}of yt(r))for(const o of n)if("command"in o){const{command:n}=o;if(n===s){let n=!1;try{r=i(r),n=!0}catch(t){yield{error:`${t}`}}if(n){const{res:{err:n},str:s}=t.set(e,r);s&&(r=s),n&&(yield{error:n.message})}}}for(const{name:t,label:e}of yt(r))yield{command:t,label:e||t};yield{title:"Rule"},yield{value:r},yield{help:gt(r)}}))}colorPrompt(){const{hash:t}=this,e="colors";return y((function*(n){for(const r of n)if("value"in r){const{value:n}=r,{res:{err:s},str:i}=t.set(e,n);if(!s)return!0;yield{error:s.message},yield{value:i||n},yield{title:"Colors"}}}),(function*(){const n=t.getStr(e);yield{value:n},yield{title:"Colors"}}))}calcSteps(t){if(!this.lastStepTime)return this.lastStepTime=t,0;const e=t-this.lastStepTime;return e>0&&this.animTiming.collect(e),this.throttle(),Math.round(e/1e3*this.stepRate)}stepWorld(t){if(this.locked)return;const e=this.calcSteps(t);e<1||(1==e?this.world.step():this.world.stepn(e),this.stepTimes.push(t,e),this.lastStepTime=t)}updateFPS(t){for(this.animTimes.push(t);t-this.animTimes[0]>3e3;)this.animTimes.shift();for(;t-this.stepTimes[0]>3e3;)this.stepTimes.shift();if(this.showFPS){this.$step.innerText="#"+this.world.stepCount,this.$fps.innerText=this.computeFPS().toFixed(0)+"fps",this.$sps.innerText=se(this.computeSPS())+"sps";var e=this.world.redrawTimingStats();this.$redrawTiming.innerText=e?"µ="+se(e.m1/1e3)+"s 𝜎="+se(Math.sqrt(e.m2/1e3))+"s":""}}throttle(){if(this.animTiming.complete()&&!(this.animTiming.sinceWeightedMark()<=3)){if(this.stepRate>1){if(this.computeFPS()<20)return this.animTiming.weightedMark(2),void(this.stepRate/=2)}var t=this.animTiming.classifyAnomalies(),e=t.length-1;this.stepRate>1&&t[e]>.5&&t[e-1]>.5&&t[e-2]>.5?(this.stepRate/=2,this.animTiming.weightedMark(2)):this.stepRate<this.goalStepRate&&t[e]<=0&&t[e-1]<=0&&t[e-2]<=0&&(this.stepRate*=2,this.animTiming.weightedMark(.5))}}computeFPS(){return this.animTimes.length/3e3*1e3}computeSPS(){let t=0;for(var e=1;e<this.stepTimes.length;e+=2)t+=this.stepTimes[e];return t/3e3*1e3}async play(){if(!this.locked)for(this.paused=!1,this.animTimes.length=0,this.stepTimes.length=0,this.animTiming.reset(),this.$fps.innerText="",this.$sps.innerText="",this.$redrawTiming.innerText="",this.lastStepTime=null;!this.paused;){const t=await ie(this.window);try{this.stepWorld(t),this.updateFPS(t)}catch(t){this.pause(),this.locked=!0,le(t,"Hexant playtime",["config",Object.fromEntries(this.hash.stringEntries())],["step",this.world.stepCount],["fps",this.computeFPS()],["sps",this.computeSPS()],["redrawTiming",this.world.redrawTimingStats()])}}}pause(){this.paused=!0,this.$fps.innerText="<"+this.$fps.innerText+">",this.$sps.innerText="<"+this.$sps.innerText+">",this.$redrawTiming.innerText="<"+this.$redrawTiming.innerText+">",this.lastStepTime=null}playpause(){this.paused?this.play():this.pause()}stepit(){this.paused?this.locked||this.world.step():this.pause()}setStepRate(t){this.stepRate===this.goalStepRate&&(this.stepRate=t),this.goalStepRate=t}resize(t,e){this.view.resize(t,e)}}({$body:document.querySelector("#main")});function ue(){const{innerWidth:t,innerHeight:e,document:{documentElement:{clientWidth:n,clientHeight:r}}}=window,s=Math.max(n,t||0),i=Math.max(r,e||0);ae.resize(s,i)}window.addEventListener("resize",(()=>ue())),ue();
//# sourceMappingURL=index.bundle.min.js.map
